<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kavach360 - Tourist Safety Dashboard</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- HTML2Canvas for ID Card Download -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Multilingual Support CSS -->
    <link rel="stylesheet" href="multilingual.css">
    
    <!-- Leaflet.js for Maps - Local files first, CDN fallback -->
    <link rel="stylesheet" href="leaflet/leaflet.css" onerror="loadLeafletCSSFallback()">
    <script src="leaflet/leaflet.js" onerror="loadLeafletFallback()"></script>
    
    <!-- Digital ID Module -->
    <script src="digital-id.js" defer></script>
    <script>
        // Debug Leaflet loading
        console.log('Script loading started...');
        
        // Fallback for Leaflet CSS loading
        function loadLeafletCSSFallback() {
            console.warn('Local Leaflet CSS failed, trying CDN fallback...');
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            link.onerror = function() {
                console.error('All Leaflet CSS sources failed');
            };
            document.head.appendChild(link);
        }
        
        // Fallback for Leaflet loading
        function loadLeafletFallback() {
            console.warn('Local Leaflet JS failed, trying CDN fallback...');
            tryMultipleCDNs();
        }
        
        // Try multiple CDNs for Leaflet
        function tryMultipleCDNs() {
            const cdns = [
                'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js',
                'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js',
                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
            ];
            
            let currentIndex = 0;
            
            function tryNextCDN() {
                if (currentIndex >= cdns.length) {
                    console.error('All Leaflet CDNs failed');
                    showNotification('Map library failed to load. Please check your internet connection.', 'error');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdns[currentIndex];
                script.onload = function() {
                    console.log(`Leaflet loaded from CDN ${currentIndex + 1}: ${cdns[currentIndex]}`);
                    window.dispatchEvent(new CustomEvent('leafletReady'));
                };
                script.onerror = function() {
                    console.warn(`CDN ${currentIndex + 1} failed: ${cdns[currentIndex]}`);
                    currentIndex++;
                    tryNextCDN();
                };
                document.head.appendChild(script);
            }
            
            tryNextCDN();
        }
        
        // Check if Leaflet loads successfully from local files
        window.addEventListener('load', function() {
            console.log('Window loaded, checking Leaflet...');
            if (typeof L !== 'undefined') {
                console.log('Leaflet loaded from local files');
                window.dispatchEvent(new CustomEvent('leafletReady'));
            } else {
                console.warn('Leaflet not loaded from local files');
            }
        });
        
        // Also check immediately after script loads
        setTimeout(() => {
            if (typeof L !== 'undefined') {
                console.log('Leaflet loaded immediately from local files');
                window.dispatchEvent(new CustomEvent('leafletReady'));
            }
        }, 100);
    </script>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- html2canvas for Digital ID download -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Audio for alerts -->
    <audio id="alertSound" preload="auto">
        <source src="https://cdn.jsdelivr.net/gh/rafaelreis-hotmart/Audio-Sample-Files@master/sample-6s.mp3" type="audio/mpeg">
    </audio>
    
    <style>
        :root {
            /* Color Variables */
            --primary-color: #4361ee;
            --primary-light: #4895ef;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --success-color: #00C853;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --dark-color: #212121;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --gray-light: #e9ecef;
            
            /* Layout Variables */
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 70px;
            --header-height: 70px;
            --border-radius: 10px;
            --card-border-radius: 15px;
            --transition-speed: 0.3s;
            
            /* Shadow Variables */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Tourist Marker Animations */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes sosPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(230, 57, 70, 0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(230, 57, 70, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(230, 57, 70, 0);
            }
        }
        
        .pulse-animation {
            animation: pulse 1s ease-in-out;
        }
        
        .sos-pulse-animation {
            animation: sosPulse 1.5s infinite;
        }
        
        /* SOS Notification Styles */
        .sos-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            width: 90%;
            max-width: 500px;
            background-color: #e63946;
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        .sos-notification-content {
            padding: 20px;
        }
        
        .sos-notification h3 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sos-notification p {
            margin: 5px 0;
        }
        
        .sos-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .sos-actions button {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .sos-actions .btn-primary {
            background-color: white;
            color: #e63946;
            border: none;
        }
        
        .sos-actions .btn-outline {
            background-color: transparent;
            color: white;
            border: 1px solid white;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        /* Dashboard Container */
        .dashboard {
            display: flex;
            min-height: 100vh;
            position: relative;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            position: fixed;
            transition: all var(--transition-speed) ease;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 5px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 20px;
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .menu-category {
            padding: 10px 20px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 15px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            margin: 2px 0;
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--accent-color);
        }
        
        .menu-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }
        
        .badge {
            background-color: var(--accent-color);
            color: white;
            border-radius: 50px;
            padding: 2px 8px;
            font-size: 10px;
            margin-left: auto;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-speed) ease;
            padding: 20px;
            padding-top: calc(var(--header-height) + 20px);
        }
        
        /* Dashboard Header */
        .dashboard-header {
            height: var(--header-height);
            background-color: white;
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
            transition: left var(--transition-speed) ease;
            z-index: 900;
        }
        
        #menuToggle {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-color);
        }
        
        .header-search {
            display: flex;
            align-items: center;
            background-color: var(--gray-light);
            border-radius: 50px;
            padding: 8px 15px;
            flex: 0 0 300px;
        }
        
        .header-search i {
            color: var(--gray-color);
            margin-right: 10px;
        }
        
        .header-search input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            color: var(--dark-color);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
        }
        
        .header-icon {
            position: relative;
            margin-right: 20px;
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
        }
        
        .header-icon .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            overflow: hidden;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            line-height: 1.2;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Tab Content Styles */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        /* Card Styles */
        .card {
            background-color: white;
            border-radius: var(--card-border-radius);
            box-shadow: var(--shadow-md);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-light);
            outline: none;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #00a844;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Alert Styles */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .alert i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .alert-success {
            background-color: rgba(0, 200, 83, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .alert-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        /* Dashboard Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Stat Card */
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .stat-icon.primary {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }

        .stat-icon.success {
            background-color: rgba(0, 200, 83, 0.1);
            color: var(--success-color);
        }

        .stat-icon.warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }

        .stat-icon.danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-color);
        }

        /* Map Container */
        .map-container {
            height: 400px;
            border-radius: var(--card-border-radius);
            overflow: hidden;
            position: relative;
        }

        #geofenceMap, #map {
            height: 100%;
            width: 100%;
            border-radius: var(--card-border-radius);
        }

        .map-coordinates {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .map-instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Digital ID Card */
        .digital-id-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--card-border-radius);
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .digital-id-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        .digital-id-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .digital-id-logo {
            font-weight: 700;
            font-size: 20px;
        }

        .digital-id-qr {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            width: 100px;
            height: 100px;
        }

        .digital-id-info {
            position: relative;
            z-index: 1;
        }

        .digital-id-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .digital-id-details {
            margin-top: 15px;
        }

        .digital-id-detail {
            display: flex;
            margin-bottom: 10px;
        }

        .detail-label {
            width: 100px;
            font-size: 12px;
            opacity: 0.8;
        }

        .detail-value {
            font-weight: 500;
        }

        .digital-id-footer {
            margin-top: 20px;
            font-size: 12px;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .table th {
            font-weight: 600;
            color: var(--dark-color);
            background-color: rgba(0, 0, 0, 0.02);
        }

        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .table .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.active {
            background-color: rgba(0, 200, 83, 0.1);
            color: var(--success-color);
        }

        .status.inactive {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .status.pending {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-color);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Performance optimizations */
        .card {
            will-change: transform;
        }
        
        .map-container {
            will-change: transform;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 1200px) {
            .dashboard-grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-search {
                flex: 0 0 200px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 100%;
                max-width: 300px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 10px;
                padding-top: calc(var(--header-height) + 10px);
            }

            .dashboard-header {
                left: 0;
                padding: 0 15px;
            }

            #menuToggle {
                display: block;
            }

            .dashboard-grid-2, .dashboard-grid-3 {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .header-search {
                display: none;
            }

            .header-actions {
                gap: 10px;
            }

            .user-profile .user-info {
                display: none;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .stat-value {
                font-size: 20px;
            }

            .map-container {
                height: 300px;
            }

            .digital-id-card {
                padding: 20px;
            }

            .digital-id-qr {
                width: 80px;
                height: 80px;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                min-width: 600px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .form-control {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 5px;
                padding-top: calc(var(--header-height) + 5px);
            }

            .card {
                padding: 10px;
                margin-bottom: 10px;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
                margin-right: 10px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 12px;
            }

            .map-container {
                height: 250px;
            }

            .digital-id-card {
                padding: 15px;
            }

            .digital-id-qr {
                width: 60px;
                height: 60px;
            }

            .digital-id-name {
                font-size: 16px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .form-control {
                padding: 6px 10px;
                font-size: 12px;
            }

            .table th, .table td {
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .menu-item {
                padding: 15px 20px;
            }

            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            .header-icon {
                padding: 10px;
            }

            .user-avatar {
                width: 44px;
                height: 44px;
            }
        }

        /* FAQ Styles */
        .faq-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .faq-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-item h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 16px;
        }

        .faq-item p {
            margin: 0;
            color: var(--gray-color);
            line-height: 1.5;
        }

        /* Status indicators for geofence zones */
        .status.safe {
            background-color: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.restricted {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.active {
            background-color: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.inactive {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Map loading indicator */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
        }

        .map-loading i {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* Zone highlighting styles */
        .zone-highlight-marker {
            background: transparent !important;
            border: none !important;
        }

        .highlight-marker {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        .highlight-marker i {
            color: #00ff00;
            font-size: 14px;
        }

        .highlight-text {
            white-space: nowrap;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Zone selection buttons */
        .zone-select-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
        }

        .zone-select-btn:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Kavach360</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="menu-category">Main</div>
                <a href="#dashboard" class="menu-item active" data-tab="dashboard-tab">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#geofencing" class="menu-item" data-tab="geofencing-tab">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Geofencing</span>
                </a>
                <a href="#tourists" class="menu-item" data-tab="tourists-tab">
                    <i class="fas fa-users"></i>
                    <span>Tourists</span>
                    <span class="badge">24</span>
                </a>
                
                <div class="menu-category">Digital ID</div>
                <a href="#digital-id" class="menu-item" data-tab="digital-id-tab">
                    <i class="fas fa-id-card"></i>
                    <span>ID Management</span>
                </a>
                <a href="#verification" class="menu-item" data-tab="verification-tab">
                    <i class="fas fa-check-circle"></i>
                    <span>Verification</span>
                </a>
                
                <div class="menu-category">Monitoring</div>
                <a href="#alerts" class="menu-item" data-tab="alerts-tab">
                    <i class="fas fa-bell"></i>
                    <span>Alerts</span>
                    <span class="badge">5</span>
                </a>
                <a href="#sos" class="menu-item" data-tab="sos-tab">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>SOS Requests</span>
                    <span class="badge">2</span>
                </a>
                <a href="#analytics" class="menu-item" data-tab="analytics-tab">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </a>
                
                <div class="menu-category">Account</div>
                <a href="#profile" class="menu-item" data-tab="profile-tab">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
                
                <div class="menu-category">Settings</div>
                <a href="#settings" class="menu-item" data-tab="settings-tab">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#help" class="menu-item" data-tab="help-tab">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <div>
                    <i class="fas fa-bars" id="menuToggle"></i>
                </div>
                
                <div class="header-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search...">
                </div>
                
                <div class="header-actions">
                    <div class="header-icon">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                    
                    <div class="header-icon">
                        <i class="fas fa-envelope"></i>
                        <span class="badge">5</span>
                    </div>
                    
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">
                            <span id="userInitials">U</span>
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">Loading...</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <h2>Dashboard Overview</h2>
                <p>Welcome to the Kavach360 Tourist Safety Platform dashboard.</p>
                
                <!-- Stats Overview -->
                <div class="dashboard-grid-3">
                    <div class="card stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">1,248</div>
                            <div class="stat-label">Active Tourists</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="geofence-zones-count">42</div>
                            <div class="stat-label">Geofence Zones</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="active-alerts-count">7</div>
                            <div class="stat-label">Active Alerts</div>
                        </div>
                    </div>
                </div>
                
                <!-- Map and Alerts -->
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Tourist Locations</h3>
                            <button class="btn btn-outline btn-sm">View All</button>
                        </div>
                        <div class="map-container">
                            <div id="map"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Alerts</h3>
                            <button class="btn btn-outline btn-sm">View All</button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tourist</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Sarah Johnson</td>
                                        <td>Geofence Exit</td>
                                        <td>North Ridge</td>
                                        <td>10:23 AM</td>
                                        <td><span class="status active">Active</span></td>
                                    </tr>
                                    <tr>
                                        <td>Mike Chen</td>
                                        <td>SOS Alert</td>
                                        <td>East Valley</td>
                                        <td>09:45 AM</td>
                                        <td><span class="status active">Active</span></td>
                                    </tr>
                                    <tr>
                                        <td>Emma Wilson</td>
                                        <td>Geofence Entry</td>
                                        <td>South Beach</td>
                                        <td>Yesterday</td>
                                        <td><span class="status inactive">Resolved</span></td>
                                    </tr>
                                    <tr>
                                        <td>Alex Patel</td>
                                        <td>Check-in Missed</td>
                                        <td>West Hills</td>
                                        <td>Yesterday</td>
                                        <td><span class="status inactive">Resolved</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tourist Activity</h3>
                        <div>
                            <button class="btn btn-outline btn-sm">Daily</button>
                            <button class="btn btn-outline btn-sm">Weekly</button>
                            <button class="btn btn-outline btn-sm">Monthly</button>
                        </div>
                    </div>
                    <canvas id="activityChart" height="100"></canvas>
                </div>
            </div>
            
            <!-- Digital ID Tab -->
            <div id="digital-id-tab" class="tab-content">
                <h2>Digital ID Management</h2>
                <p>Create and manage secure digital identities for tourists.</p>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Create Digital ID</h3>
                        </div>
                        <form id="digitalIdForm">
                            <div class="form-group">
                                <label class="form-label">Tourist Name</label>
                                <input type="text" class="form-control" id="touristName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Passport/ID Number</label>
                                <input type="text" class="form-control" id="passportNumber" placeholder="Enter passport or ID number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nationality</label>
                                <input type="text" class="form-control" id="nationality" placeholder="Enter nationality">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="dateOfBirth">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" class="form-control" id="contactNumber" placeholder="Enter contact number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" placeholder="Enter email address">
                            </div>
                            <button type="submit" class="btn btn-success">Generate Digital ID</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Digital ID Preview</h3>
                        </div>
                        <div class="digital-id-card">
                            <div class="digital-id-header">
                                <div class="digital-id-logo">
                                    <i class="fas fa-shield-alt"></i> Kavach360
                                </div>
                                <div class="digital-id-qr" id="qrCode"></div>
                            </div>
                            <div class="digital-id-info">
                                <div class="digital-id-name" id="idName">Tourist Name</div>
                                <div id="idPassport">ID: XXXXXXXX</div>
                                
                                <div class="digital-id-details">
                                    <div class="digital-id-detail">
                                        <div class="detail-label">Nationality:</div>
                                        <div class="detail-value" id="idNationality">-</div>
                                    </div>
                                    <div class="digital-id-detail">
                                        <div class="detail-label">DOB:</div>
                                        <div class="detail-value" id="idDob">-</div>
                                    </div>
                                    <div class="digital-id-detail">
                                        <div class="detail-label">Issue Date:</div>
                                        <div class="detail-value" id="idIssueDate">-</div>
                                    </div>
                                    <div class="digital-id-detail">
                                        <div class="detail-label">Valid Until:</div>
                                        <div class="detail-value" id="idValidUntil">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="digital-id-footer">
                                Secured by Blockchain Technology
                            </div>
                        </div>
                        <div class="card-footer" style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" id="downloadId" onclick="downloadDigitalID()">Download ID</button>
                            <button class="btn btn-outline" id="shareId" onclick="shareDigitalID()">Share ID</button>
                            <button class="btn btn-warning" id="regenerateQR" onclick="regenerateQRCode()">Regenerate QR</button>
                            <button class="btn btn-info" id="verifyQR" onclick="openVerificationPage()">Verify QR</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Digital IDs</h3>
                        <div>
                            <input type="text" class="form-control" placeholder="Search IDs" style="width: 200px;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>ID Number</th>
                                    <th>Issue Date</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>John Smith</td>
                                    <td>KV-2023-001</td>
                                    <td>01/06/2023</td>
                                    <td>01/06/2024</td>
                                    <td><span class="status active">Active</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline">View</button>
                                        <button class="btn btn-sm btn-danger">Revoke</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Maria Garcia</td>
                                    <td>KV-2023-002</td>
                                    <td>05/06/2023</td>
                                    <td>05/06/2024</td>
                                    <td><span class="status active">Active</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline">View</button>
                                        <button class="btn btn-sm btn-danger">Revoke</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>David Lee</td>
                                    <td>KV-2023-003</td>
                                    <td>10/06/2023</td>
                                    <td>10/06/2024</td>
                                    <td><span class="status inactive">Revoked</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline">View</button>
                                        <button class="btn btn-sm btn-success">Reactivate</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Geofencing Tab -->
            <div id="geofencing-tab" class="tab-content">
                <h2>Geofencing Management</h2>
                <p>Create and manage geofence zones for tourist safety.</p>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Create Geofence Zone</h3>
                        </div>
                        <form id="geofenceForm">
                            <div class="form-group">
                                <label class="form-label">Zone Name</label>
                                <input type="text" class="form-control" id="zoneName" placeholder="Enter zone name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zone Type</label>
                                <select class="form-control" id="zoneType" required>
                                    <option value="">Select zone type</option>
                                    <option value="safe">Safe Zone</option>
                                    <option value="warning">Warning Zone</option>
                                    <option value="restricted">Restricted Zone</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Latitude</label>
                                <input type="number" class="form-control" id="zoneLatitude" step="any" placeholder="Enter latitude" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Longitude</label>
                                <input type="number" class="form-control" id="zoneLongitude" step="any" placeholder="Enter longitude" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Radius (meters)</label>
                                <input type="number" class="form-control" id="zoneRadius" placeholder="Enter radius in meters" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="zoneDescription" rows="3" placeholder="Enter zone description"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">Create Zone</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Geofence Zones Map</h3>
                            <div>
                                <button class="btn btn-outline btn-sm" onclick="refreshGeofenceMap()">Refresh</button>
                                <button class="btn btn-warning btn-sm" onclick="clearAllHighlights()">Clear Highlights</button>
                            </div>
                        </div>
                        <div class="map-container">
                            <div id="geofenceMap"></div>
                            <div class="map-coordinates" id="mapCoordinates">
                                Click on map to select coordinates
                            </div>
                            <div class="map-instructions">
                                Click anywhere on the map to set latitude and longitude
                            </div>
                            <div class="map-loading" id="mapLoading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <div>Loading map...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Active Geofence Zones</h3>
                        <div>
                            <input type="text" class="form-control" id="geofenceSearch" placeholder="Search zones" style="width: 200px;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="geofenceTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Location</th>
                                    <th>Radius</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="geofenceTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">Loading zones...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="tourists-tab" class="tab-content">
                <h2>Tourist Management</h2>
                <p>Monitor and manage tourist profiles and activities.</p>
                
                <!-- Tourist Stats -->
                <div class="dashboard-grid-3">
                    <div class="card stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalTourists">0</div>
                            <div class="stat-label">Total Tourists</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="activeTourists">0</div>
                            <div class="stat-label">Active Now</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="checkinOverdue">0</div>
                            <div class="stat-label">Check-in Overdue</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tourist Management Tools -->
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Tourist Search & Filter</h3>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" id="touristSearch" placeholder="Search by name, email, or ID">
                        </div>
                        <div class="form-group">
                            <select class="form-control" id="touristFilter">
                                <option value="">All Tourists</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="overdue">Check-in Overdue</option>
                            </select>
                        </div>
                        <button class="btn btn-outline" onclick="searchTourists()">Search</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-success" onclick="sendBulkNotification()">
                                <i class="fas fa-bell"></i> Send Notification
                            </button>
                            <button class="btn btn-warning" onclick="exportTouristData()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="btn btn-primary" onclick="refreshTouristData()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tourist List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tourist Directory</h3>
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="refreshTouristData()">Refresh</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="touristTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Nationality</th>
                                    <th>Last Check-in</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="touristTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">Loading tourists...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="verification-tab" class="tab-content">
                <h2>ID Verification</h2>
                <p>Verify digital IDs and manage verification requests.</p>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Scan QR Code</h3>
                        </div>
                        <div style="text-align: center; padding: 20px;">
                            <div id="qrScanner" style="width: 300px; height: 300px; margin: 0 auto; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9;">
                                <div style="text-align: center;">
                                    <i class="fas fa-qrcode" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                                    <p>Click to scan QR code</p>
                                    <button class="btn btn-primary" onclick="startQRScan()">Start Scanner</button>
                                </div>
                            </div>
                            <div id="scanResult" style="margin-top: 20px; display: none;">
                                <h4>Scan Result:</h4>
                                <div id="scanData" style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;"></div>
                                <button class="btn btn-success" onclick="verifyID()">Verify ID</button>
                                <button class="btn btn-outline" onclick="clearScan()">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Manual Verification</h3>
                        </div>
                        <form id="manualVerificationForm">
                            <div class="form-group">
                                <label class="form-label">ID Number</label>
                                <input type="text" class="form-control" id="manualIdNumber" placeholder="Enter ID number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="manualFullName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="manualDob">
                            </div>
                            <button type="submit" class="btn btn-primary">Verify Manually</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Verification History</h3>
                        <div>
                            <input type="text" class="form-control" id="verificationSearch" placeholder="Search verifications" style="width: 200px;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="verificationTable">
                            <thead>
                                <tr>
                                    <th>ID Number</th>
                                    <th>Name</th>
                                    <th>Verification Date</th>
                                    <th>Status</th>
                                    <th>Verified By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="verificationTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center;">No verification history found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="alerts-tab" class="tab-content">
                <h2>Alert Management</h2>
                <p>Monitor and respond to safety alerts.</p>
                
                <!-- Alert Stats -->
                <div class="dashboard-grid-3">
                    <div class="card stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="activeAlertsCount">0</div>
                            <div class="stat-label">Active Alerts</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="pendingAlertsCount">0</div>
                            <div class="stat-label">Pending Response</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="resolvedAlertsCount">0</div>
                            <div class="stat-label">Resolved Today</div>
                        </div>
                    </div>
                </div>
                
                <!-- Alert Filters -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Alert Filters</h3>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <select class="form-control" id="alertTypeFilter">
                                <option value="">All Types</option>
                                <option value="geofence_exit">Geofence Exit</option>
                                <option value="geofence_entry">Geofence Entry</option>
                                <option value="sos">SOS Alert</option>
                                <option value="checkin_missed">Missed Check-in</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <select class="form-control" id="alertStatusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <input type="date" class="form-control" id="alertDateFilter">
                        </div>
                        <button class="btn btn-outline" onclick="filterAlerts()">Filter</button>
                        <button class="btn btn-primary" onclick="refreshAlerts()">Refresh</button>
                    </div>
                </div>
                
                <!-- Alerts List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Alerts</h3>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="markAllAsRead()">Mark All Read</button>
                            <button class="btn btn-outline btn-sm" onclick="refreshAlerts()">Refresh</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="alertsTable">
                            <thead>
                                <tr>
                                    <th>Tourist</th>
                                    <th>Type</th>
                                    <th>Message</th>
                                    <th>Location</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">Loading alerts...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="sos-tab" class="tab-content">
                <h2>SOS Requests</h2>
                <p>Handle emergency SOS requests from tourists.</p>
                
                <!-- SOS Stats -->
                <div class="dashboard-grid-3">
                    <div class="card stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="activeSOSCount">0</div>
                            <div class="stat-label">Active SOS</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="avgResponseTime">0m</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="resolvedSOSToday">0</div>
                            <div class="stat-label">Resolved Today</div>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Emergency Actions</h3>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-danger" onclick="sendEmergencyAlert()">
                            <i class="fas fa-broadcast-tower"></i> Send Emergency Alert
                        </button>
                        <button class="btn btn-warning" onclick="contactEmergencyServices()">
                            <i class="fas fa-phone"></i> Contact Emergency Services
                        </button>
                        <button class="btn btn-primary" onclick="refreshSOSData()">
                            <i class="fas fa-sync"></i> Refresh SOS Data
                        </button>
                    </div>
                </div>
                
                <!-- SOS Requests List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Active SOS Requests</h3>
                        <div>
                            <select class="form-control" id="sosFilter" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="responding">Responding</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="sosTable">
                            <thead>
                                <tr>
                                    <th>Tourist</th>
                                    <th>Location</th>
                                    <th>Emergency Type</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sosTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">No active SOS requests</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Emergency Contacts -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Emergency Contacts</h3>
                    </div>
                    <div class="dashboard-grid-2">
                        <div>
                            <h4>Local Emergency Services</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <span><strong>Police</strong></span>
                                    <button class="btn btn-sm btn-outline" onclick="callEmergency('100')">Call 100</button>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <span><strong>Ambulance</strong></span>
                                    <button class="btn btn-sm btn-outline" onclick="callEmergency('108')">Call 108</button>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <span><strong>Fire Department</strong></span>
                                    <button class="btn btn-sm btn-outline" onclick="callEmergency('101')">Call 101</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4>Tourist Helpline</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <span><strong>Tourist Helpline</strong></span>
                                    <button class="btn btn-sm btn-outline" onclick="callEmergency('1363')">Call 1363</button>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <span><strong>Women Helpline</strong></span>
                                    <button class="btn btn-sm btn-outline" onclick="callEmergency('181')">Call 181</button>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <span><strong>Child Helpline</strong></span>
                                    <button class="btn btn-sm btn-outline" onclick="callEmergency('1098')">Call 1098</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="analytics-tab" class="tab-content">
                <h2>Analytics</h2>
                <p>View detailed analytics and reports.</p>
                
                <!-- Analytics Filters -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Analytics Filters</h3>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <select class="form-control" id="analyticsTimeRange">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d" selected>Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="1y">Last Year</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <select class="form-control" id="analyticsMetric">
                                <option value="all">All Metrics</option>
                                <option value="tourists">Tourist Activity</option>
                                <option value="alerts">Alert Trends</option>
                                <option value="geofence">Geofence Usage</option>
                                <option value="sos">SOS Requests</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="updateAnalytics()">Update Analytics</button>
                        <button class="btn btn-outline" onclick="exportAnalytics()">Export Report</button>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="dashboard-grid-4">
                    <div class="card stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalTouristActivity">0</div>
                            <div class="stat-label">Total Tourist Activity</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="geofenceViolations">0</div>
                            <div class="stat-label">Geofence Violations</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="alertResponseTime">0m</div>
                            <div class="stat-label">Avg Alert Response</div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="sosResponseTime">0m</div>
                            <div class="stat-label">Avg SOS Response</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Tourist Activity Over Time</h3>
                        </div>
                        <canvas id="touristActivityChart" height="200"></canvas>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Alert Types Distribution</h3>
                        </div>
                        <canvas id="alertTypesChart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Geofence Zone Activity</h3>
                        </div>
                        <canvas id="geofenceActivityChart" height="200"></canvas>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Response Time Trends</h3>
                        </div>
                        <canvas id="responseTimeChart" height="200"></canvas>
                    </div>
                </div>
                
                <!-- AI Anomaly Detection -->
                <div id="anomalyDashboard" class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-robot"></i> AI Anomaly Detection</h3>
                        <div class="card-actions">
                            <button id="refreshAnomalyData" class="btn btn-icon"><i class="fas fa-sync-alt"></i></button>
                            <button id="exportAnomalyData" class="btn btn-icon"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="dashboard-grid-2">
                            <div class="anomaly-stats">
                                <div class="stat-card">
                                    <div class="stat-icon warning">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="totalAnomalies">0</div>
                                        <div class="stat-label">Total Anomalies</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="criticalAnomalies">0</div>
                                        <div class="stat-label">Critical Anomalies</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon primary">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="affectedTourists">0</div>
                                        <div class="stat-label">Affected Tourists</div>
                                    </div>
                                </div>
                            </div>
                            <div class="anomaly-chart-container">
                                <canvas id="anomalyChart"></canvas>
                            </div>
                        </div>
                        <div class="anomaly-heatmap-container">
                            <h4>Anomaly Heatmap</h4>
                            <div id="anomalyHeatmap"></div>
                        </div>
                        <div class="anomaly-list-container">
                            <h4>Recent Anomalies</h4>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Tourist</th>
                                            <th>Type</th>
                                            <th>Confidence</th>
                                            <th>Location</th>
                                            <th>Time</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="anomalyTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center">No anomalies detected</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Reports -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Detailed Reports</h3>
                    </div>
                    <div class="table-container">
                        <table class="table" id="analyticsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Tourist Check-ins</th>
                                    <th>Alerts Generated</th>
                                    <th>Geofence Violations</th>
                                    <th>SOS Requests</th>
                                    <th>Avg Response Time</th>
                                </tr>
                            </thead>
                            <tbody id="analyticsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center;">Loading analytics data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="settings-tab" class="tab-content">
                <h2>Settings</h2>
                <p>Configure system settings and preferences.</p>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Configuration</h3>
                        </div>
                        <form id="systemSettingsForm">
                            <div class="form-group">
                                <label class="form-label">Platform Name</label>
                                <input type="text" class="form-control" id="platformName" value="Kavach360">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Geofence Radius (meters)</label>
                                <input type="number" class="form-control" id="defaultGeofenceRadius" value="1000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert Check Interval (seconds)</label>
                                <input type="number" class="form-control" id="alertCheckInterval" value="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SOS Response Timeout (minutes)</label>
                                <input type="number" class="form-control" id="sosTimeout" value="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Retention Period (days)</label>
                                <input type="number" class="form-control" id="dataRetention" value="365">
                            </div>
                            <button type="submit" class="btn btn-success">Save Settings</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Notification Settings</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Notifications</label>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailAlerts" checked>
                                    <span>Alert Notifications</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailSOS" checked>
                                    <span>SOS Notifications</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailReports">
                                    <span>Daily Reports</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SMS Notifications</label>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="smsAlerts">
                                    <span>Critical Alerts</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="smsSOS" checked>
                                    <span>SOS Alerts</span>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Notifications</button>
                    </div>
                </div>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Security Settings</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session Timeout (minutes)</label>
                            <input type="number" class="form-control" id="sessionTimeout" value="60">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password Policy</label>
                            <select class="form-control" id="passwordPolicy">
                                <option value="basic">Basic (6+ characters)</option>
                                <option value="medium" selected>Medium (8+ chars, mixed case)</option>
                                <option value="strong">Strong (12+ chars, special chars)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Two-Factor Authentication</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="twoFactorAuth">
                                <span>Enable 2FA</span>
                            </div>
                        </div>
                        <button class="btn btn-warning" onclick="saveSecuritySettings()">Save Security</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Database Management</h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-outline" onclick="backupDatabase()">
                                <i class="fas fa-download"></i> Backup Database
                            </button>
                            <button class="btn btn-warning" onclick="optimizeDatabase()">
                                <i class="fas fa-tools"></i> Optimize Database
                            </button>
                            <button class="btn btn-danger" onclick="clearOldData()">
                                <i class="fas fa-trash"></i> Clear Old Data
                            </button>
                        </div>
                        <hr style="margin: 20px 0;">
                        <div class="form-group">
                            <label class="form-label">Database Status</label>
                            <div id="databaseStatus" style="padding: 10px; background: #d4edda; border-radius: 5px; color: #155724;">
                                <i class="fas fa-check-circle"></i> Database Connected
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Information</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td><strong>System Version</strong></td>
                                    <td id="systemVersion">Kavach360 v1.0.0</td>
                                </tr>
                                <tr>
                                    <td><strong>Node.js Version</strong></td>
                                    <td id="nodeVersion">v18.17.0</td>
                                </tr>
                                <tr>
                                    <td><strong>Database Version</strong></td>
                                    <td id="dbVersion">SQLite 3.42.0</td>
                                </tr>
                                <tr>
                                    <td><strong>Uptime</strong></td>
                                    <td id="systemUptime">2 days, 5 hours</td>
                                </tr>
                                <tr>
                                    <td><strong>Memory Usage</strong></td>
                                    <td id="memoryUsage">45.2 MB</td>
                                </tr>
                                <tr>
                                    <td><strong>CPU Usage</strong></td>
                                    <td id="cpuUsage">12.5%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content">
                <h2>User Profile</h2>
                <p>Manage your account settings and profile information.</p>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Profile Information</h3>
                        </div>
                        <form id="profileForm">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="profileFullName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="profileEmail" placeholder="Enter email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="profileUsername" placeholder="Enter username">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nationality</label>
                                <input type="text" class="form-control" id="profileNationality" placeholder="Enter nationality">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="profilePhone" placeholder="Enter phone number">
                            </div>
                            <button type="submit" class="btn btn-success">Update Profile</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Account Settings</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Change Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Current password">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="newPassword" placeholder="New password">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="confirmNewPassword" placeholder="Confirm new password">
                        </div>
                        <button class="btn btn-warning" onclick="changePassword()">Change Password</button>
                        
                        <hr style="margin: 20px 0;">
                        
                        <div class="form-group">
                            <label class="form-label">Notification Preferences</label>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span>Email Notifications</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="pushNotifications" checked>
                                    <span>Push Notifications</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="smsNotifications">
                                    <span>SMS Notifications</span>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateNotificationSettings()">Save Preferences</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Account Actions</h3>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-outline" onclick="exportUserData()">
                            <i class="fas fa-download"></i> Export My Data
                        </button>
                        <button class="btn btn-warning" onclick="requestDataDeletion()">
                            <i class="fas fa-trash"></i> Request Data Deletion
                        </button>
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="help-tab" class="tab-content">
                <h2>Help & Support</h2>
                <p>Get help and support for using the platform.</p>
                
                <div class="dashboard-grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Frequently Asked Questions</h3>
            </div>
                        <div class="faq-section">
                            <div class="faq-item">
                                <h4>How do I create a geofence zone?</h4>
                                <p>Go to the Geofencing tab, fill in the zone details, and click "Create Zone". The zone will be active immediately.</p>
                            </div>
                            <div class="faq-item">
                                <h4>How do I generate a digital ID?</h4>
                                <p>Navigate to Digital ID tab, fill in the tourist information, and click "Generate Digital ID". A QR code will be created automatically.</p>
                            </div>
                            <div class="faq-item">
                                <h4>How do I respond to alerts?</h4>
                                <p>Go to the Alerts tab, select an alert, and use the action buttons to mark as read, resolve, or escalate.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Contact Support</h3>
                        </div>
                        <form id="supportForm">
                            <div class="form-group">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="supportSubject" placeholder="Enter subject" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-control" id="supportCategory" required>
                                    <option value="">Select category</option>
                                    <option value="technical">Technical Issue</option>
                                    <option value="billing">Billing Question</option>
                                    <option value="feature">Feature Request</option>
                                    <option value="bug">Bug Report</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                <textarea class="form-control" id="supportMessage" rows="5" placeholder="Describe your issue or question" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Support Request</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Information</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td><strong>Platform Version</strong></td>
                                    <td id="platformVersion">Kavach360 v1.0.0</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated</strong></td>
                                    <td id="lastUpdated">2025-01-06</td>
                                </tr>
                                <tr>
                                    <td><strong>Database Status</strong></td>
                                    <td id="databaseStatus">Connected</td>
                                </tr>
                                <tr>
                                    <td><strong>WebSocket Status</strong></td>
                                    <td id="websocketStatus">Connected</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Check if user is authenticated
        async function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                console.log('No authentication token found, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                // Verify token with server
                const response = await fetch('http://localhost:3000/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    mode: 'cors' // Explicitly set CORS mode
                });
                
                if (!response.ok) {
                    console.log('Token verification failed, redirecting to login');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return false;
                }
                
                const userData = await response.json();
                console.log('User profile data:', userData);
                
                // Update user profile information
                if (userData.data && userData.data.user) {
                    const userInfo = userData.data.user;
                        const profileData = userData.data.profile || {};
                    
                    // Update header user profile
                    const userName = profileData.full_name || userInfo.username || 'User';
                    const userRole = userInfo.role || 'User';
                    
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userRole').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                    
                    // Generate user initials
                    const initials = userName.split(' ').map(name => name.charAt(0)).join('').toUpperCase().slice(0, 2);
                    document.getElementById('userInitials').textContent = initials;
                    
                    // Update profile form fields
                        if (document.getElementById('profileFullName')) {
                        document.getElementById('profileFullName').value = profileData.full_name || '';
                        }
                        if (document.getElementById('profileEmail')) {
                        document.getElementById('profileEmail').value = userInfo.email || '';
                    }
                    if (document.getElementById('profileUsername')) {
                        document.getElementById('profileUsername').value = userInfo.username || '';
                        }
                        if (document.getElementById('profileNationality')) {
                        document.getElementById('profileNationality').value = profileData.nationality || '';
                        }
                    if (document.getElementById('profilePhone')) {
                        document.getElementById('profilePhone').value = profileData.emergency_phone || '';
                    }
                }
                
                // Token is valid
                return true;
            } catch (error) {
                console.error('Error verifying token:', error);
                console.log('Server might be down, continuing with local token');
                return true; // Continue with local token if server is down
            }
        }
        
        // Fetch alerts from the server
        async function fetchAlerts() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No authentication token found');
                    return;
                }
                
                // Add loading state
                const alertsCard = document.querySelector('.card:has(.table)');
                if (alertsCard) {
                    alertsCard.classList.add('loading');
                }
                
                const response = await fetch('http://localhost:3000/api/dashboard/alerts/recent?limit=10', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Authentication expired, redirecting to login');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    console.error('Failed to fetch alerts:', response.status);
                    showNotification('Failed to fetch alerts', 'error');
                    return;
                }
                
                const alertsData = await response.json();
                console.log('Alerts data:', alertsData);
                
                // Update alerts count in the dashboard
                if (alertsData.data && Array.isArray(alertsData.data)) {
                    const activeAlerts = alertsData.data.filter(alert => !alert.read_at && alert.status !== 'resolved');
                    const pendingAlerts = alertsData.data.filter(alert => alert.status === 'pending');
                    const resolvedAlerts = alertsData.data.filter(alert => alert.status === 'resolved');
                    
                    // Update dashboard stats
                    const alertCountElements = document.querySelectorAll('.stat-value');
                    alertCountElements.forEach(el => {
                        if (el.nextElementSibling && el.nextElementSibling.textContent.includes('Alerts')) {
                            el.textContent = activeAlerts.length;
                        }
                    });
                    
                    // Update alerts tab stats
                    const activeAlertsCount = document.getElementById('activeAlertsCount');
                    const pendingAlertsCount = document.getElementById('pendingAlertsCount');
                    const resolvedAlertsCount = document.getElementById('resolvedAlertsCount');
                    
                    if (activeAlertsCount) activeAlertsCount.textContent = activeAlerts.length;
                    if (pendingAlertsCount) pendingAlertsCount.textContent = pendingAlerts.length;
                    if (resolvedAlertsCount) resolvedAlertsCount.textContent = resolvedAlerts.length;
                    
                    // Update alerts table if it exists
                    updateAlertsTable(alertsData.data);
                    
                    // Update sidebar badge
                    const alertsBadge = document.querySelector('.menu-item[data-tab="alerts-tab"] .badge');
                    if (alertsBadge) {
                        alertsBadge.textContent = activeAlerts.length;
                    }
                }
            } catch (error) {
                console.error('Error fetching alerts:', error);
                showNotification('Network error while fetching alerts', 'error');
            } finally {
                // Remove loading state
                const alertsCard = document.querySelector('.card:has(.table)');
                if (alertsCard) {
                    alertsCard.classList.remove('loading');
                }
            }
        }
        
        // Update alerts table with real data
        function updateAlertsTable(alerts) {
            // Target the alerts table in the alerts tab
            const alertsTable = document.querySelector('#alertsTableBody');
            if (!alertsTable) {
                console.log('Alerts table body not found');
                return;
            }
            
            // Clear existing rows
            alertsTable.innerHTML = '';
            
            // Add new rows with real data
            alerts.slice(0, 4).forEach(alert => {
                const row = document.createElement('tr');
                
                // Format date
                const alertDate = new Date(alert.created_at);
                const timeString = alertDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateString = alertDate.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? timeString 
                    : alertDate.toLocaleDateString();
                
                // Map API fields to display fields
                const userName = alert.full_name || alert.user_name || 'Unknown';
                const alertType = alert.alert_type || alert.type || 'Alert';
                const description = alert.description || 'No description';
                const severity = alert.severity || 'medium';
                const status = alert.status || 'pending';
                
                // Get location info
                const location = alert.latitude && alert.longitude 
                    ? `${alert.latitude.toFixed(4)}, ${alert.longitude.toFixed(4)}`
                    : 'Unknown';
                
                row.innerHTML = `
                    <td>${userName}</td>
                    <td>${alertType}</td>
                    <td>${description}</td>
                    <td>${location}</td>
                    <td>${dateString}</td>
                    <td>
                        <span class="badge badge-${status}">${status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="markAlertRead(${alert.id})">Mark Read</button>
                        <button class="btn btn-sm btn-success" onclick="resolveAlert(${alert.id})">Resolve</button>
                    </td>
                `;
                
                alertsTable.appendChild(row);
            });
            
            // If no alerts, show a message
            if (alerts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center;">No alerts found</td>';
                alertsTable.appendChild(row);
            }
        }
        
        // Mark alert as read
        async function markAlertRead(alertId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to perform this action', 'error');
                    return;
                }

                const response = await fetch(`http://localhost:3000/api/alerts/${alertId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('Alert marked as read', 'success');
                    fetchAlerts(); // Refresh alerts
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to mark alert as read', 'error');
                }
            } catch (error) {
                console.error('Error marking alert as read:', error);
                showNotification('Network error while marking alert as read', 'error');
            }
        }

        // Resolve alert
        async function resolveAlert(alertId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to perform this action', 'error');
                    return;
                }

                const response = await fetch(`http://localhost:3000/api/alerts/${alertId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'resolved' })
                });

                if (response.ok) {
                    showNotification('Alert resolved successfully', 'success');
                    fetchAlerts(); // Refresh alerts
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to resolve alert', 'error');
                }
            } catch (error) {
                console.error('Error resolving alert:', error);
                showNotification('Network error while resolving alert', 'error');
            }
        }

        // Mark all alerts as read
        async function markAllAsRead() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to perform this action', 'error');
                    return;
                }

                const response = await fetch('http://localhost:3000/api/alerts/read/all', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('All alerts marked as read', 'success');
                    fetchAlerts(); // Refresh alerts
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to mark all alerts as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all alerts as read:', error);
                showNotification('Network error while marking all alerts as read', 'error');
            }
        }

        // Refresh alerts
        function refreshAlerts() {
            fetchAlerts();
            showNotification('Alerts refreshed', 'info');
        }

        // Check if server is running
        async function checkServerHealth() {
            try {
                const response = await fetch('http://localhost:3000/api/test', { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                console.error('Server health check failed:', error);
                return false;
            }
        }

        // Fetch geofence zones from the server
        async function fetchGeofenceZones() {
            try {
                console.log('Fetching geofence zones...');
                
                // Check if server is running first
                const serverRunning = await checkServerHealth();
                if (!serverRunning) {
                    showNotification('Server is not running. Please start the backend server.', 'error');
                    return [];
                }
                
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No authentication token found');
                    showNotification('Please log in to view geofence zones', 'warning');
                    return [];
                }
                
                console.log('Making API request to:', 'http://localhost:3000/api/geofence');
                const response = await fetch('http://localhost:3000/api/geofence', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Authentication expired, redirecting to login');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return [];
                    }
                    console.error('Failed to fetch geofence zones:', response.status, response.statusText);
                    showNotification(`Failed to fetch geofence zones: ${response.status} ${response.statusText}`, 'error');
                    return [];
                }
                
                const zonesData = await response.json();
                console.log('Geofence zones data received:', zonesData);
                
                // Validate the response structure
                if (!zonesData || typeof zonesData !== 'object') {
                    console.error('Invalid response structure:', zonesData);
                    showNotification('Invalid data received from server', 'error');
                    return [];
                }
                
                // Update geofence zones count in the dashboard
                if (zonesData.data && Array.isArray(zonesData.data)) {
                    const zoneCountElements = document.querySelectorAll('.stat-value');
                    zoneCountElements.forEach(el => {
                        if (el.nextElementSibling && el.nextElementSibling.textContent.includes('Geofence')) {
                            el.textContent = zonesData.data.length;
                        }
                    });
                    
                    // Update geofence table with error handling
                    try {
                        updateGeofenceTable(zonesData.data);
                    } catch (tableError) {
                        console.error('Error updating geofence table:', tableError);
                        showNotification('Error displaying geofence zones table', 'warning');
                    }
                } else {
                    console.warn('No geofence zones data in response:', zonesData);
                }
                
                return zonesData.data || [];
            } catch (error) {
                console.error('Error fetching geofence zones:', error);
                
                // Provide more specific error messages
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showNotification('Cannot connect to server. Please check if the backend is running.', 'error');
                } else if (error.name === 'NetworkError') {
                    showNotification('Network error. Please check your internet connection.', 'error');
                } else {
                    showNotification(`Error fetching geofence zones: ${error.message}`, 'error');
                }
                return [];
            }
        }

        // Update geofence table
        function updateGeofenceTable(zones) {
            const tableBody = document.getElementById('geofenceTableBody');
            if (!tableBody) return;

            if (!zones || zones.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No geofence zones found</td></tr>';
                return;
            }

            tableBody.innerHTML = zones.map(zone => {
                // Extract coordinates safely
                const latitude = zone.coordinates ? zone.coordinates.latitude : zone.latitude;
                const longitude = zone.coordinates ? zone.coordinates.longitude : zone.longitude;
                
                // Format coordinates safely
                const latStr = (latitude && typeof latitude === 'number') ? latitude.toFixed(4) : 'N/A';
                const lngStr = (longitude && typeof longitude === 'number') ? longitude.toFixed(4) : 'N/A';
                
                return `
                    <tr>
                        <td>${zone.name || 'Unnamed'}</td>
                        <td><span class="status ${zone.type || 'unknown'}">${zone.type || 'Unknown'}</span></td>
                        <td>${latStr}, ${lngStr}</td>
                        <td>${zone.radius || 0}m</td>
                        <td><span class="status ${zone.is_active ? 'active' : 'inactive'}">${zone.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${zone.created_at ? new Date(zone.created_at).toLocaleDateString() : 'Unknown'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="editGeofenceZone(${zone.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteGeofenceZone(${zone.id})">Delete</button>
                            <button class="zone-select-btn" onclick="selectZone(${zone.id}, ${JSON.stringify(zone).replace(/"/g, '&quot;')})">Select</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update map with real geofence zones
        function updateMapWithGeofenceZones(zones) {
            // Check if map exists
            if (!document.getElementById('map')) return;
            
            // Clear existing map
            const mapContainer = document.getElementById('map');
            mapContainer.innerHTML = '';
            
            // Initialize map with better default view
            const map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([28.6139, 77.2090], 13); // Default to Delhi coordinates
            
            // Add tile layer with better styling
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Store map reference globally for updates
            window.dashboardMap = map;
            
            // If no zones, add a default marker and message
            if (zones.length === 0) {
                L.marker([28.6139, 77.2090]).addTo(map)
                    .bindPopup('<b>No geofence zones defined yet</b><br>Create zones to monitor tourist safety');
                return;
            }
            
            // Add markers and circles for each zone
            const bounds = L.latLngBounds();
            const zoneMarkers = [];
            
            zones.forEach((zone, index) => {
                const lat = zone.coordinates ? zone.coordinates.latitude : zone.latitude;
                const lng = zone.coordinates ? zone.coordinates.longitude : zone.longitude;
                
                if (!lat || !lng) return;
                
                // Determine zone color based on type
                const zoneColor = zone.type === 'restricted' ? 'red' : 
                                 zone.type === 'warning' ? 'orange' : 'blue';
                const fillColor = zone.type === 'restricted' ? '#e63946' : 
                                 zone.type === 'warning' ? '#ff9500' : '#4361ee';
                
                // Add marker with custom icon
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${zoneColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">${index + 1}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: ${zoneColor};">${zone.name || 'Unnamed Zone'}</h4>
                        <p><strong>Type:</strong> ${zone.type || 'Unknown'}</p>
                        <p><strong>Radius:</strong> ${zone.radius || 0}m</p>
                        <p><strong>Status:</strong> ${zone.active ? 'Active' : 'Inactive'}</p>
                        <p><strong>Created:</strong> ${new Date(zone.created_at).toLocaleDateString()}</p>
                    </div>
                `);
                
                // Add circle for geofence
                const circle = L.circle([lat, lng], {
                    color: zoneColor,
                    fillColor: fillColor,
                    fillOpacity: 0.2,
                    radius: zone.radius || 1000, // meters
                    weight: 2
                }).addTo(map);
                
                // Add popup to circle as well
                circle.bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: ${zoneColor};">${zone.name || 'Unnamed Zone'}</h4>
                        <p><strong>Type:</strong> ${zone.type || 'Unknown'}</p>
                        <p><strong>Radius:</strong> ${zone.radius || 0}m</p>
                        <p><strong>Status:</strong> ${zone.active ? 'Active' : 'Inactive'}</p>
                    </div>
                `);
                
                zoneMarkers.push({ marker, circle, zone });
                
                // Extend bounds to include this zone
                bounds.extend([lat, lng]);
            });
            
            // Store markers for future updates
            window.dashboardMapMarkers = zoneMarkers;
            
            // Fit map to bounds of all zones
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
            
            // Add legend
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = `
                    <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        <h4 style="margin: 0 0 10px 0;">Zone Types</h4>
                        <div><span style="color: #4361ee;"></span> Safe Zone</div>
                        <div><span style="color: #ff9500;"></span> Warning Zone</div>
                        <div><span style="color: #e63946;"></span> Restricted Zone</div>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        /**
         * Fetch dashboard statistics from the API
         */
        async function fetchDashboardStats() {
          try {
            const token = localStorage.getItem('token');
            if (!token) {
              console.warn('No authentication token found');
              return;
            }
        
            const response = await fetch('http://localhost:3000/api/dashboard/stats', {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              credentials: 'include',
              mode: 'cors'
            });
        
            if (!response.ok) {
              if (response.status === 401) {
                console.log('Authentication expired, redirecting to login');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                return;
              }
              throw new Error(`Error: ${response.status}`);
            }
        
            const data = await response.json();
            if (data.status === 'success') {
              updateDashboardStats(data.data.stats);
            }
          } catch (error) {
            console.error('Error fetching dashboard stats:', error);
            showNotification('Failed to fetch dashboard statistics', 'error');
          }
        }
        
        /**
         * Update dashboard UI with statistics
         */
        function updateDashboardStats(data) {
          // Update statistics cards
          const geofenceCountEl = document.getElementById('geofence-zones-count');
          const alertsCountEl = document.getElementById('active-alerts-count');
          
          if (geofenceCountEl && data.stats) {
            geofenceCountEl.textContent = data.stats.geofenceZones || 0;
          }
          
          if (alertsCountEl && data.stats) {
            alertsCountEl.textContent = data.stats.activeAlerts || 0;
          }
          
          // Update activity chart
          if (window.activityChart && data.activityData) {
            window.activityChart.data.labels = data.activityData.labels;
            window.activityChart.data.datasets[0].data = data.activityData.data;
            window.activityChart.update();
          }
          
          // Update recent alerts if available
          if (data.recentAlerts && Array.isArray(data.recentAlerts)) {
            updateAlertsTable(data.recentAlerts);
          }
        }
        
        /**
         * Show notification to user
         */
        function showNotification(message, type = 'info') {
          // Create notification element
          const notification = document.createElement('div');
          notification.className = `alert alert-${type}`;
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
          `;
          
          const icon = type === 'error' ? 'fas fa-exclamation-circle' : 
                      type === 'success' ? 'fas fa-check-circle' : 
                      'fas fa-info-circle';
          
          notification.innerHTML = `
            <i class="${icon}"></i>
            ${message}
            <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;"></button>
          `;
          
          document.body.appendChild(notification);
          
          // Auto remove after 5 seconds
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, 5000);
        }
        
        // Performance monitoring
        function logPerformance(message, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            console.log(`${message}: ${duration.toFixed(2)}ms`);
            
            // Log slow operations
            if (duration > 1000) {
                console.warn(`Slow operation detected: ${message} took ${duration.toFixed(2)}ms`);
            }
        }
        
        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // WebSocket connection for real-time updates
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function initializeWebSocket() {
            try {
                socket = io('http://localhost:3001', {
                    transports: ['websocket', 'polling'],
                    timeout: 20000,
                    forceNew: true
                });
                
                socket.on('connect', function() {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    showNotification('Real-time connection established', 'success');
                });
                
                socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                    showNotification('Real-time connection lost', 'warning');
                });
                
                socket.on('connect_error', function(error) {
                    console.error('WebSocket connection error:', error);
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(initializeWebSocket, 2000 * reconnectAttempts);
                    }
                });
                
                // Real-time alert updates
                socket.on('new_alert', function(alert) {
                    console.log('New alert received:', alert);
                    showNotification(`New ${alert.type} alert from ${alert.user_name}`, 'warning');
                    fetchAlerts(); // Refresh alerts
                });
                
                // Real-time geofence updates
                socket.on('geofence_update', function(data) {
                    console.log('Geofence update received:', data);
                    fetchGeofenceZones(); // Refresh geofence data
                });
                
                // Real-time tourist location updates
                socket.on('tourist_location_update', function(data) {
                    console.log('Tourist location update:', data);
                    updateTouristLocationOnMap(data);
                });
                
                // Real-time dashboard stats updates
                socket.on('dashboard_stats_update', function(stats) {
                    console.log('Dashboard stats update:', stats);
                    updateDashboardStats(stats);
                });
                
                // Real-time zone selection updates
                socket.on('zone_selected', function(data) {
                    console.log('Zone selected by another user:', data);
                    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                    
                    // Don't highlight if it's the current user's selection
                    if (data.userId !== currentUser.id) {
                        highlightZone(data.zoneId, data.zoneData, data.userId, data.userName);
                        showNotification(`${data.userName} selected zone "${data.zoneData.name}"`, 'info');
                    }
                });
                
                // Zone selection cleared
                socket.on('zone_cleared', function(data) {
                    console.log('Zone selection cleared:', data);
                    removeZoneHighlight(data.zoneId);
                });
                
            } catch (error) {
                console.error('Failed to initialize WebSocket:', error);
            }
        }
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            const initStartTime = performance.now();
            
        // Test local file accessibility
        fetch('leaflet/leaflet.js', { method: 'HEAD' })
            .then(response => {
                console.log('Local Leaflet file accessible:', response.ok);
            })
            .catch(error => {
                console.error('Local Leaflet file not accessible:', error);
            });
        
        // Test CDN accessibility
        fetch('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', { method: 'HEAD' })
            .then(response => {
                console.log('Primary CDN accessible:', response.ok);
            })
            .catch(error => {
                console.error('Primary CDN not accessible:', error);
            });
        
        // Check if Leaflet is loaded
        waitForLeaflet(() => {
            console.log('Leaflet library is ready');
            leafletReady = true;
        });
        
        // Add a simple test to verify basic functionality
        setTimeout(() => {
            console.log('=== Leaflet Debug Info ===');
            console.log('Window loaded:', document.readyState);
            console.log('L defined:', typeof L !== 'undefined');
            console.log('L.map defined:', typeof L?.map !== 'undefined');
            console.log('Scripts loaded:', document.scripts.length);
            console.log('========================');
        }, 2000);
            
            // Check authentication first
            if (!await checkAuthentication()) return;
            
            // Initialize WebSocket connection
            initializeWebSocket();
            
            // Fetch real-time data
            fetchAlerts();
            fetchGeofenceZones();
            fetchDashboardStats();
            
            // Set up periodic refresh with better error handling
            let refreshIntervals = [];
            
            // Function to start periodic updates
            function startPeriodicUpdates() {
                // Clear existing intervals
                refreshIntervals.forEach(interval => clearInterval(interval));
                refreshIntervals = [];
                
                // Set up new intervals with different frequencies
                refreshIntervals.push(setInterval(fetchAlerts, 30000)); // Every 30 seconds
                refreshIntervals.push(setInterval(fetchGeofenceZones, 60000)); // Every minute
                refreshIntervals.push(setInterval(fetchDashboardStats, 120000)); // Every 2 minutes
                
                console.log('Periodic updates started');
            }
            
            // Function to stop periodic updates
            function stopPeriodicUpdates() {
                refreshIntervals.forEach(interval => clearInterval(interval));
                refreshIntervals = [];
                console.log('Periodic updates stopped');
            }
            
            // Start periodic updates
            startPeriodicUpdates();
            
            // Pause updates when tab is not visible (performance optimization)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopPeriodicUpdates();
                } else {
                    // Resume updates and fetch fresh data
                    startPeriodicUpdates();
                    fetchAlerts();
                    fetchGeofenceZones();
                    fetchDashboardStats();
                }
            });
            
            // Tab switching functionality with smooth transitions
            const menuItems = document.querySelectorAll('.menu-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all menu items and tabs
                    menuItems.forEach(i => i.classList.remove('active'));
                    tabContents.forEach(tab => tab.classList.remove('active'));
                    
                    // Add active class to clicked menu item
                    this.classList.add('active');
                    
                    // Show corresponding tab with animation
                    const tabId = this.getAttribute('data-tab');
                    const targetTab = document.getElementById(tabId);
                    
                    if (targetTab) {
                        targetTab.classList.add('active');
                        
                        // Fetch data when specific tabs are opened
                        if (tabId === 'alerts-tab') {
                            console.log('Alerts tab opened, fetching alerts...');
                            fetchAlerts();
                        }
                        
                        // Trigger specific actions based on tab
                        switch(tabId) {
                            case 'dashboard-tab':
                                // Refresh dashboard data when switching to dashboard
                                fetchAlerts();
                                fetchGeofenceZones();
                                fetchDashboardStats();
                                break;
                            case 'alerts-tab':
                                // Refresh alerts when switching to alerts tab
                                fetchAlerts();
                                break;
                            case 'geofencing-tab':
                                // Initialize map and refresh geofence data when switching to geofencing tab
                                setTimeout(() => {
                                    // Ensure the tab is visible before initializing map
                                    if (targetTab.classList.contains('active')) {
                                        console.log('Geofencing tab clicked, checking Leaflet status...');
                                        console.log('L object:', typeof L);
                                        console.log('L.map:', typeof L?.map);
                                        
                                        // Wait for Leaflet to be ready before initializing map
                                        waitForLeaflet(() => {
                                            console.log('Leaflet confirmed ready, initializing map...');
                                            initializeGeofenceMap();
                                            // Fetch zones after map is initialized
                                            setTimeout(async () => {
                                                try {
                                                    await fetchGeofenceZones();
                                                } catch (error) {
                                                    console.error('Error in geofencing tab:', error);
                                                    showNotification('Error loading geofence data. Please check if the server is running.', 'warning');
                                                }
                                            }, 300);
                                        });
                                    }
                                }, 200);
                                break;
                        }
                        
                        // Close mobile sidebar after navigation
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                            const overlay = document.querySelector('.sidebar-overlay');
                            if (overlay) {
                                overlay.remove();
                            }
                        }
                        
                        // Update page title
                        const tabTitle = this.querySelector('span').textContent;
                        document.title = `${tabTitle} - Kavach360 Dashboard`;
                    }
                });
            });
            
            // Add keyboard navigation support
            document.addEventListener('keydown', function(e) {
                if (e.altKey) {
                    const activeTab = document.querySelector('.menu-item.active');
                    const activeIndex = Array.from(menuItems).indexOf(activeTab);
                    
                    switch(e.key) {
                        case 'ArrowDown':
                        case 'ArrowRight':
                            e.preventDefault();
                            const nextIndex = (activeIndex + 1) % menuItems.length;
                            menuItems[nextIndex].click();
                            break;
                        case 'ArrowUp':
                        case 'ArrowLeft':
                            e.preventDefault();
                            const prevIndex = activeIndex === 0 ? menuItems.length - 1 : activeIndex - 1;
                            menuItems[prevIndex].click();
                            break;
                    }
                }
            });
            
            // Mobile menu toggle with better UX
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                
                // Add overlay for mobile
                if (sidebar.classList.contains('active')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'sidebar-overlay';
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.5);
                        z-index: 999;
                        animation: fadeIn 0.3s ease;
                    `;
                    document.body.appendChild(overlay);
                    
                    // Close sidebar when overlay is clicked
                    overlay.addEventListener('click', function() {
                        sidebar.classList.remove('active');
                        overlay.remove();
                    });
                } else {
                    // Remove overlay if it exists
                    const existingOverlay = document.querySelector('.sidebar-overlay');
                    if (existingOverlay) {
                        existingOverlay.remove();
                    }
                }
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    const isClickInsideSidebar = sidebar.contains(e.target);
                    const isClickOnToggle = menuToggle.contains(e.target);
                    
                    if (!isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        const overlay = document.querySelector('.sidebar-overlay');
                        if (overlay) {
                            overlay.remove();
                        }
                    }
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                    const overlay = document.querySelector('.sidebar-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }
            });
            
            // Initialize map if we're on the dashboard tab
            if (document.getElementById('map')) {
                // Initialize with empty map first
                const map = L.map('map', {
                    zoomControl: true,
                    attributionControl: true
                }).setView([28.6139, 77.2090], 13); // Delhi coordinates
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Store map reference globally
                window.dashboardMap = map;
                
                // Add loading indicator
                const loadingMarker = L.marker([28.6139, 77.2090]).addTo(map)
                    .bindPopup('<b>Loading geofence zones...</b>');
                
                // Remove loading marker when zones are loaded
                setTimeout(() => {
                    if (loadingMarker && map.hasLayer(loadingMarker)) {
                        map.removeLayer(loadingMarker);
                    }
                }, 2000);
            }
            
            // Initialize activity chart
            if (document.getElementById('activityChart')) {
                const ctx = document.getElementById('activityChart').getContext('2d');
                window.activityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Tourist Check-ins',
                            data: [65, 59, 80, 81, 56, 55, 40],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Alerts',
                            data: [28, 48, 40, 19, 86, 27, 90],
                            borderColor: '#F44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
            }
            
            // Digital ID Form Handling
            const digitalIdForm = document.getElementById('digitalIdForm');
            if (digitalIdForm) {
                digitalIdForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form values
                    const name = document.getElementById('touristName').value.trim();
                    const passport = document.getElementById('passportNumber').value.trim();
                    const nationality = document.getElementById('nationality').value.trim();
                    const dob = document.getElementById('dateOfBirth').value;
                    const contact = document.getElementById('contactNumber').value.trim();
                    const email = document.getElementById('email').value.trim();
                    
                    // Basic validation
                    if (!name) {
                        showNotification('Please enter tourist name', 'error');
                        return;
                    }
                    
                    if (!passport) {
                        showNotification('Please enter passport/ID number', 'error');
                        return;
                    }
                    
                    if (!nationality) {
                        showNotification('Please enter nationality', 'error');
                        return;
                    }
                    
                    if (!dob) {
                        showNotification('Please select date of birth', 'error');
                        return;
                    }
                    
                    // Update ID preview
                    document.getElementById('idName').textContent = name;
                    document.getElementById('idPassport').textContent = `ID: ${passport}`;
                    document.getElementById('idNationality').textContent = nationality;
                    document.getElementById('idDob').textContent = new Date(dob).toLocaleDateString();
                    
                    // Set issue date and expiry date
                    const today = new Date();
                    const expiryDate = new Date();
                    expiryDate.setFullYear(today.getFullYear() + 1);
                    
                    document.getElementById('idIssueDate').textContent = today.toLocaleDateString();
                    document.getElementById('idValidUntil').textContent = expiryDate.toLocaleDateString();
                    
                    // Generate QR code
                    const qrData = JSON.stringify({
                        name,
                        passport,
                        nationality,
                        dob,
                        contact,
                        email,
                        issueDate: today.toISOString(),
                        expiryDate: expiryDate.toISOString(),
                        hash: 'blockchain-verification-hash-' + Date.now()
                    });
                    
                    const qrCode = document.getElementById('qrCode');
                    qrCode.innerHTML = '';
                    QRCode.toCanvas(qrCode, qrData, { 
                        width: 100,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function(error) {
                        if (error) {
                            console.error('QR Code generation error:', error);
                            showNotification('Failed to generate QR code', 'error');
                        } else {
                            showNotification('Digital ID created successfully!', 'success');
                        }
                    });
                });
            }
            
            // Add download and share functionality for Digital ID
            const downloadBtn = document.getElementById('downloadId');
            const shareBtn = document.getElementById('shareId');
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    // Create a canvas to capture the digital ID card
                    const card = document.querySelector('.digital-id-card');
                    if (card) {
                        html2canvas(card).then(canvas => {
                            const link = document.createElement('a');
                            link.download = 'digital-id.png';
                            link.href = canvas.toDataURL();
                            link.click();
                            showNotification('Digital ID downloaded successfully!', 'success');
                        }).catch(error => {
                            console.error('Download error:', error);
                            showNotification('Failed to download Digital ID', 'error');
                        });
                    }
                });
            }
            
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    if (navigator.share) {
                        navigator.share({
                            title: 'Digital Tourist ID',
                            text: 'Check out this digital tourist ID',
                            url: window.location.href
                        }).catch(error => {
                            console.error('Share error:', error);
                            showNotification('Failed to share Digital ID', 'error');
                        });
                    } else {
                        // Fallback: copy to clipboard
                        const qrData = document.querySelector('#qrCode canvas');
                        if (qrData) {
                            qrData.toBlob(blob => {
                                const item = new ClipboardItem({ 'image/png': blob });
                                navigator.clipboard.write([item]).then(() => {
                                    showNotification('Digital ID copied to clipboard!', 'success');
                                }).catch(error => {
                                    console.error('Copy error:', error);
                                    showNotification('Failed to copy Digital ID', 'error');
                                });
                            });
                        }
                    }
                });
            }
            
            // Log initialization performance
            logPerformance('Dashboard initialization completed', initStartTime);
            
            // Show welcome notification
            setTimeout(() => {
                showNotification('Dashboard loaded successfully!', 'success');
            }, 1000);
        });
        
        // Global map variables
        let geofenceMap = null;
        let geofenceMarkers = [];
        let geofenceCircles = [];
        let mapInitRetryCount = 0;
        const MAX_MAP_RETRIES = 3;
        let leafletReady = false;
        let touristMarkers = {}; // Store tourist markers by ID
        
        // Zone highlighting variables
        let highlightedZones = new Map(); // Store highlighted zones by zoneId
        let userZoneSelections = new Map(); // Store user selections

        // Check if Leaflet is ready
        function checkLeafletReady() {
            return typeof L !== 'undefined' && L.map;
        }

        // Wait for Leaflet to be ready
        function waitForLeaflet(callback, maxWait = 10000) {
            console.log('Waiting for Leaflet to be ready...');
            
            if (checkLeafletReady()) {
                console.log('Leaflet already ready');
                leafletReady = true;
                callback();
                return;
            }
            
            let waitTime = 0;
            const checkInterval = 100;
            let interval;
            
            // Listen for custom leaflet ready event
            const handleLeafletReady = () => {
                console.log('Leaflet ready event received');
                clearInterval(interval);
                window.removeEventListener('leafletReady', handleLeafletReady);
                leafletReady = true;
                callback();
            };
            
            window.addEventListener('leafletReady', handleLeafletReady);
            
            // Also check periodically
            interval = setInterval(() => {
                waitTime += checkInterval;
                console.log(`Checking Leaflet... (${waitTime}ms)`);
                
                if (checkLeafletReady()) {
                    console.log('Leaflet ready via polling');
                    clearInterval(interval);
                    window.removeEventListener('leafletReady', handleLeafletReady);
                    leafletReady = true;
                    callback();
                } else if (waitTime >= maxWait) {
                    console.error('Leaflet failed to load within timeout');
                    clearInterval(interval);
                    window.removeEventListener('leafletReady', handleLeafletReady);
                    showNotification('Map library failed to load. Please refresh the page.', 'error');
                }
            }, checkInterval);
        }

        // Initialize geofence map
        function initializeGeofenceMap() {
            try {
                console.log('Initializing geofence map...');
                
                // Check if the map container exists
                const mapContainer = document.getElementById('geofenceMap');
                if (!mapContainer) {
                    console.error('Geofence map container not found');
                    showNotification('Map container not found. Please refresh the page.', 'error');
                    return;
                }

                // Check if the container is visible
                if (mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {
                    console.warn('Map container not visible, retrying in 100ms');
                    setTimeout(() => initializeGeofenceMap(), 100);
                    return;
                }
                
                if (geofenceMap) {
                    geofenceMap.remove();
                }

                // Show loading indicator
                const loadingIndicator = document.getElementById('mapLoading');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }

                // Check if Leaflet is loaded (should be ready at this point)
                if (!checkLeafletReady()) {
                    console.error('Leaflet library not loaded');
                    showNotification('Map library not loaded. Please refresh the page.', 'error');
                    return;
                }

                // Initialize map centered on India
                geofenceMap = L.map('geofenceMap').setView([20.5937, 78.9629], 5);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(geofenceMap);

                // Hide loading indicator when map is ready
                geofenceMap.whenReady(() => {
                    console.log('Geofence map initialized successfully');
                    mapInitRetryCount = 0; // Reset retry count on success
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    
                    // Invalidate map size to ensure proper rendering
                    setTimeout(() => {
                        geofenceMap.invalidateSize();
                    }, 100);
                    
                    // Add click event to get coordinates
                    geofenceMap.on('click', function(e) {
                        const lat = e.latlng.lat.toFixed(6);
                        const lng = e.latlng.lng.toFixed(6);
                        
                        // Update coordinate display
                        document.getElementById('mapCoordinates').textContent = `Lat: ${lat}, Lng: ${lng}`;
                        
                        // Update form fields
                        document.getElementById('zoneLatitude').value = lat;
                        document.getElementById('zoneLongitude').value = lng;
                        
                        // Add temporary marker
                        if (geofenceMap.tempMarker) {
                            geofenceMap.removeLayer(geofenceMap.tempMarker);
                        }
                        geofenceMap.tempMarker = L.marker([lat, lng]).addTo(geofenceMap);
                        
                        showNotification(`Coordinates selected: ${lat}, ${lng}`, 'info');
                    });
                });

                // Load existing geofence zones
                loadGeofenceZonesOnMap();
            } catch (error) {
                console.error('Error initializing geofence map:', error);
                
                if (mapInitRetryCount < MAX_MAP_RETRIES) {
                    mapInitRetryCount++;
                    showNotification(`Failed to initialize map. Retrying... (${mapInitRetryCount}/${MAX_MAP_RETRIES})`, 'warning');
                    
                    // Retry after a short delay
                    setTimeout(() => {
                        console.log(`Retrying geofence map initialization... (attempt ${mapInitRetryCount})`);
                        initializeGeofenceMap();
                    }, 1000);
                } else {
                    showNotification('Failed to initialize map after multiple attempts. Please refresh the page.', 'error');
                    mapInitRetryCount = 0; // Reset for future attempts
                }
            }
        }

        // Load geofence zones on map
        function loadGeofenceZonesOnMap() {
            if (!geofenceMap) {
                console.warn('Geofence map not initialized, skipping zone loading');
                return;
            }

            try {
                // Clear existing markers and circles
                geofenceMarkers.forEach(marker => geofenceMap.removeLayer(marker));
                geofenceCircles.forEach(circle => geofenceMap.removeLayer(circle));
                geofenceMarkers = [];
                geofenceCircles = [];

                // Fetch and display geofence zones
                fetchGeofenceZones().then(zones => {
                    console.log('Loading geofence zones on map:', zones);
                    if (zones && zones.length > 0) {
                        zones.forEach(zone => {
                            try {
                                // Extract coordinates from the API response structure
                                const latitude = zone.coordinates ? zone.coordinates.latitude : zone.latitude;
                                const longitude = zone.coordinates ? zone.coordinates.longitude : zone.longitude;
                                
                                // Validate coordinates more thoroughly
                                if (!latitude || !longitude || 
                                    typeof latitude !== 'number' || typeof longitude !== 'number' ||
                                    isNaN(latitude) || isNaN(longitude)) {
                                    console.warn('Invalid coordinates for zone:', zone);
                                    console.warn('Latitude:', latitude, 'Longitude:', longitude);
                                    return;
                                }
                                
                                // Validate coordinate ranges
                                if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
                                    console.warn('Coordinates out of valid range for zone:', zone);
                                    return;
                                }
                                
                                // Add marker for zone center
                                const marker = L.marker([latitude, longitude])
                                    .bindPopup(`
                                        <strong>${zone.name}</strong><br>
                                        Type: ${zone.type}<br>
                                        Radius: ${zone.radius}m<br>
                                        ${zone.description ? `Description: ${zone.description}` : ''}
                                    `)
                                    .addTo(geofenceMap);
                                geofenceMarkers.push(marker);

                                // Add circle for geofence zone
                                const circle = L.circle([latitude, longitude], {
                                    color: zone.type === 'safe' ? 'green' : zone.type === 'warning' ? 'orange' : 'red',
                                    fillColor: zone.type === 'safe' ? 'green' : zone.type === 'warning' ? 'orange' : 'red',
                                    fillOpacity: 0.2,
                                    radius: zone.radius
                                }).addTo(geofenceMap);
                                geofenceCircles.push(circle);
                            } catch (zoneError) {
                                console.error('Error adding zone to map:', zoneError, zone);
                            }
                        });
                        console.log(`Successfully loaded ${zones.length} geofence zones on map`);
                    } else {
                        console.log('No geofence zones to display');
                    }
                }).catch(error => {
                    console.error('Error fetching geofence zones for map:', error);
                    showNotification('Failed to load geofence zones on map', 'error');
                });
            } catch (error) {
                console.error('Error in loadGeofenceZonesOnMap:', error);
                showNotification('Failed to load geofence zones on map', 'error');
            }
        }

        // Zone highlighting functions
        function highlightZone(zoneId, zoneData, userId, userName) {
            if (!geofenceMap) return;
            
            console.log(`Highlighting zone ${zoneId} by user ${userName}`);
            
            // Remove existing highlight if any
            removeZoneHighlight(zoneId);
            
            // Create highlight circle
            const highlightCircle = L.circle([zoneData.latitude, zoneData.longitude], {
                color: zoneData.type === 'safe' ? '#00ff00' : zoneData.type === 'warning' ? '#ffaa00' : '#ff0000',
                fillColor: zoneData.type === 'safe' ? '#00ff00' : zoneData.type === 'warning' ? '#ffaa00' : '#ff0000',
                fillOpacity: 0.3,
                radius: zoneData.radius || 1000,
                weight: 3,
                dashArray: '10, 10'
            }).addTo(geofenceMap);
            
            // Create highlight marker
            const highlightMarker = L.marker([zoneData.latitude, zoneData.longitude], {
                icon: L.divIcon({
                    className: 'zone-highlight-marker',
                    html: `<div class="highlight-marker">
                        <i class="fas fa-eye"></i>
                        <span class="highlight-text">${userName}</span>
                    </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                })
            }).addTo(geofenceMap);
            
            // Store highlight data
            highlightedZones.set(zoneId, {
                circle: highlightCircle,
                marker: highlightMarker,
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
            
            // Auto-remove highlight after 30 seconds
            setTimeout(() => {
                removeZoneHighlight(zoneId);
            }, 30000);
        }
        
        function removeZoneHighlight(zoneId) {
            const highlight = highlightedZones.get(zoneId);
            if (highlight) {
                geofenceMap.removeLayer(highlight.circle);
                geofenceMap.removeLayer(highlight.marker);
                highlightedZones.delete(zoneId);
            }
        }
        
        function clearAllHighlights() {
            if (!highlightedZones || highlightedZones.size === 0) {
                showNotification('No highlights to clear', 'info');
                return;
            }
            
            let clearedCount = 0;
            highlightedZones.forEach((highlight, zoneId) => {
                try {
                    removeZoneHighlight(zoneId);
                    clearedCount++;
                } catch (error) {
                    console.error(`Error clearing highlight for zone ${zoneId}:`, error);
                }
            });
            
            showNotification(`Cleared ${clearedCount} highlight(s)`, 'success');
        }
        
        // Handle zone selection by current user
        function selectZone(zoneId, zoneData) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = currentUser.id || 'anonymous';
                const userName = currentUser.username || 'Unknown User';
                
                // Parse zone data if it's a string
                let parsedZoneData = zoneData;
                if (typeof zoneData === 'string') {
                    try {
                        parsedZoneData = JSON.parse(zoneData);
                    } catch (parseError) {
                        console.error('Error parsing zone data:', parseError);
                        showNotification('Error parsing zone data', 'error');
                        return;
                    }
                }
                
                // Validate zone data
                if (!parsedZoneData || !parsedZoneData.name) {
                    showNotification('Invalid zone data', 'error');
                    return;
                }
                
                // Store user selection
                userZoneSelections.set(zoneId, {
                    userId: userId,
                    userName: userName,
                    zoneData: parsedZoneData,
                    timestamp: Date.now()
                });
                
                // Highlight the zone locally
                highlightZone(zoneId, parsedZoneData, userId, userName);
                
                // Broadcast to other users via WebSocket
                if (window.socket) {
                    window.socket.emit('zone_selected', {
                        zoneId: zoneId,
                        zoneData: parsedZoneData,
                        userId: userId,
                        userName: userName,
                        timestamp: Date.now()
                    });
                }
                
                showNotification(`Zone "${parsedZoneData.name}" selected and highlighted`, 'info');
            } catch (error) {
                console.error('Error in selectZone:', error);
                showNotification('Error selecting zone', 'error');
            }
        }

        // Geofencing Functions
        function refreshGeofenceMap() {
            if (geofenceMap) {
                loadGeofenceZonesOnMap();
            } else {
                initializeGeofenceMap();
            }
            showNotification('Geofence map refreshed', 'success');
        }

        // Edit geofence zone
        async function editGeofenceZone(zoneId) {
            try {
                // Fetch the zone data first
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3000/api/geofence/${zoneId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to fetch zone data', 'error');
                    return;
                }

                const result = await response.json();
                const zone = result.data;

                // Populate the form with existing data
                document.getElementById('zoneName').value = zone.name || '';
                document.getElementById('zoneDescription').value = zone.description || '';
                document.getElementById('zoneLatitude').value = zone.coordinates.latitude || '';
                document.getElementById('zoneLongitude').value = zone.coordinates.longitude || '';
                document.getElementById('zoneRadius').value = zone.radius || '';
                document.getElementById('zoneType').value = zone.type || 'safe';
                document.getElementById('alertType').value = zone.alertType || 'notification';

                // Show the form and scroll to it
                const form = document.getElementById('geofenceForm');
                if (form) {
                    form.scrollIntoView({ behavior: 'smooth' });
                    
                    // Add a hidden field to track if we're editing
                    let editField = document.getElementById('editingZoneId');
                    if (!editField) {
                        editField = document.createElement('input');
                        editField.type = 'hidden';
                        editField.id = 'editingZoneId';
                        form.appendChild(editField);
                    }
                    editField.value = zoneId;

                    // Change the submit button text
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'Update Zone';
                        submitBtn.classList.add('btn-warning');
                        submitBtn.classList.remove('btn-primary');
                    }
                }

                showNotification(`Editing zone: ${zone.name}`, 'info');
            } catch (error) {
                console.error('Error fetching zone data:', error);
                showNotification('Network error while fetching zone data', 'error');
            }
        }

        // Delete geofence zone
        async function deleteGeofenceZone(zoneId) {
            if (!confirm('Are you sure you want to delete this geofence zone?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3000/api/geofence/${zoneId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('Geofence zone deleted successfully!', 'success');
                    fetchGeofenceZones();
                    if (geofenceMap) {
                        loadGeofenceZonesOnMap();
                    }
                    
                    // Update dashboard map if it exists
                    if (window.dashboardMap) {
                        try {
                            const zones = await fetchGeofenceZones();
                            updateMapWithGeofenceZones(zones);
                        } catch (error) {
                            console.error('Error updating dashboard map after deletion:', error);
                        }
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to delete geofence zone', 'error');
                }
            } catch (error) {
                console.error('Error deleting geofence zone:', error);
                showNotification('Network error while deleting geofence zone', 'error');
            }
        }
        
        // Geofence form handling
        document.addEventListener('DOMContentLoaded', function() {
            const geofenceForm = document.getElementById('geofenceForm');
            if (geofenceForm) {
                geofenceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        name: document.getElementById('zoneName').value.trim(),
                        type: document.getElementById('zoneType').value,
                        latitude: parseFloat(document.getElementById('zoneLatitude').value),
                        longitude: parseFloat(document.getElementById('zoneLongitude').value),
                        radius: parseInt(document.getElementById('zoneRadius').value),
                        description: document.getElementById('zoneDescription').value.trim(),
                        alertType: document.getElementById('alertType').value
                    };
                    
                    // Validate form data
                    if (!formData.name || !formData.latitude || !formData.longitude || !formData.radius) {
                        showNotification('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    if (isNaN(formData.latitude) || isNaN(formData.longitude) || isNaN(formData.radius)) {
                        showNotification('Please enter valid numeric values for coordinates and radius', 'error');
                        return;
                    }
                    
                    try {
                        const token = localStorage.getItem('token');
                        const editingZoneId = document.getElementById('editingZoneId');
                        const isEditing = editingZoneId && editingZoneId.value;
                        
                        let response;
                        if (isEditing) {
                            // Update existing zone
                            response = await fetch(`http://localhost:3000/api/geofence/${editingZoneId.value}`, {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });
                        } else {
                            // Create new zone
                            response = await fetch('http://localhost:3000/api/geofence', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });
                        }
                        
                        if (response.ok) {
                            const action = isEditing ? 'updated' : 'created';
                            showNotification(`Geofence zone ${action} successfully!`, 'success');
                            
                            // Reset form
                            geofenceForm.reset();
                            
                            // Remove editing state
                            if (editingZoneId) {
                                editingZoneId.remove();
                            }
                            
                            // Reset submit button
                            const submitBtn = geofenceForm.querySelector('button[type="submit"]');
                            if (submitBtn) {
                                submitBtn.textContent = 'Create Zone';
                                submitBtn.classList.remove('btn-warning');
                                submitBtn.classList.add('btn-primary');
                            }
                            
                            // Refresh data
                            fetchGeofenceZones();
                            if (geofenceMap) {
                                loadGeofenceZonesOnMap();
                            }
                            
                            // Update dashboard map if it exists
                            if (window.dashboardMap) {
                                try {
                                    const zones = await fetchGeofenceZones();
                                    if (zones && zones.length > 0) {
                                        updateMapWithGeofenceZones(zones);
                                    }
                                } catch (error) {
                                    console.error('Error updating dashboard map:', error);
                                }
                            }
                        } else {
                            const error = await response.json();
                            const action = isEditing ? 'update' : 'create';
                            showNotification(error.message || `Failed to ${action} geofence zone`, 'error');
                        }
                    } catch (error) {
                        console.error('Error with geofence zone operation:', error);
                        showNotification('Network error while processing geofence zone', 'error');
                    }
                });
            }
        });
        
        // Tourist Management Functions
        function searchTourists() {
            const searchTerm = document.getElementById('touristSearch').value.trim();
            const filter = document.getElementById('touristFilter').value;
            
            // Implement search logic
            console.log('Searching tourists:', { searchTerm, filter });
            showNotification('Search functionality will be implemented', 'info');
        }
        
        function sendBulkNotification() {
            showNotification('Bulk notification feature will be implemented', 'info');
        }
        
        function exportTouristData() {
            showNotification('Export functionality will be implemented', 'info');
        }
        
        function refreshTouristData() {
            showNotification('Tourist data refreshed', 'success');
        }
        
        // Alert Management Functions
        function filterAlerts() {
            const typeFilter = document.getElementById('alertTypeFilter').value;
            const statusFilter = document.getElementById('alertStatusFilter').value;
            const dateFilter = document.getElementById('alertDateFilter').value;
            
            console.log('Filtering alerts:', { typeFilter, statusFilter, dateFilter });
            showNotification('Alert filtering will be implemented', 'info');
        }
        
        function refreshAlerts() {
            fetchAlerts();
            showNotification('Alerts refreshed', 'success');
        }
        
        function markAllAsRead() {
            showNotification('Mark all as read functionality will be implemented', 'info');
        }
        
        // Real-time map updates
        function updateTouristLocationOnMap(locationData) {
            if (window.dashboardMap && locationData) {
                // Check if tourist marker already exists
                if (!window.touristMarkers) {
                    window.touristMarkers = {};
                }
                
                const { userId, latitude, longitude, timestamp, touristName, touristId } = locationData;
                
                if (!userId || !latitude || !longitude) {
                    console.error('Invalid location data:', locationData);
                    return;
                }
                
                // Create or update marker
                if (window.touristMarkers[userId]) {
                    // Update existing marker position
                    window.touristMarkers[userId].marker.setLatLng([latitude, longitude]);
                    
                    // Update popup content with latest info
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: #4361ee;">${touristName || 'Tourist'}</h4>
                            <p><strong>ID:</strong> ${touristId || userId}</p>
                            <p><strong>Last Update:</strong> ${new Date(timestamp).toLocaleTimeString()}</p>
                            <p><strong>Location:</strong> [${latitude.toFixed(6)}, ${longitude.toFixed(6)}]</p>
                        </div>
                    `;
                    window.touristMarkers[userId].marker.getPopup().setContent(popupContent);
                } else {
                    // Create new marker with custom icon
                    const marker = L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'tourist-marker',
                            html: `<div style="background-color: #4361ee; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user"></i></div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(window.dashboardMap);
                    
                    // Add popup with tourist info
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: #4361ee;">${touristName || 'Tourist'}</h4>
                            <p><strong>ID:</strong> ${touristId || userId}</p>
                            <p><strong>Last Update:</strong> ${new Date(timestamp).toLocaleTimeString()}</p>
                            <p><strong>Location:</strong> [${latitude.toFixed(6)}, ${longitude.toFixed(6)}]</p>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    
                    // Store marker reference
                    window.touristMarkers[userId] = { marker, data: locationData };
                }
                
                // Add pulse animation effect for recent updates
                const markerElement = window.touristMarkers[userId].marker.getElement();
                if (markerElement) {
                    markerElement.classList.add('pulse-animation');
                    setTimeout(() => {
                        markerElement.classList.remove('pulse-animation');
                    }, 2000);
                }
            }
        }
        
        // Enhanced dashboard stats update
        function updateDashboardStats(stats) {
            if (stats) {
                // Update all stat cards with new data
                const statElements = {
                    'geofence-zones-count': stats.geofenceZones,
                    'active-alerts-count': stats.activeAlerts,
                    'totalTourists': stats.totalTourists,
                    'activeTourists': stats.activeTourists,
                    'checkinOverdue': stats.checkinOverdue,
                    'activeAlertsCount': stats.activeAlerts,
                    'pendingAlertsCount': stats.pendingAlerts,
                    'resolvedAlertsCount': stats.resolvedAlerts
                };
                
                Object.entries(statElements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element && value !== undefined) {
                        element.textContent = value;
                    }
                });
            }
        }
        
        // Mobile responsiveness improvements
        function handleMobileResize() {
            const isMobile = window.innerWidth <= 768;
            const sidebar = document.querySelector('.sidebar');
            
            if (isMobile && sidebar.classList.contains('active')) {
                // Auto-close sidebar on mobile after navigation
                setTimeout(() => {
                    sidebar.classList.remove('active');
                    const overlay = document.querySelector('.sidebar-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }, 300);
            }
        }
        
        // Add resize listener
        window.addEventListener('resize', debounce(handleMobileResize, 250));
        
        // Performance monitoring for mobile
        function monitorPerformance() {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                if (perfData) {
                    console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
                    
                    // Log slow loading on mobile
                    if (window.innerWidth <= 768 && (perfData.loadEventEnd - perfData.loadEventStart) > 3000) {
                        console.warn('Slow page load detected on mobile device');
                    }
                }
            }
        }
        
        // Call performance monitoring after page load
        window.addEventListener('load', monitorPerformance);
        
        // Profile Management Functions
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill in all password fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters long', 'error');
                return;
            }
            
            // Implement password change logic
            showNotification('Password change functionality will be implemented', 'info');
        }
        
        function updateNotificationSettings() {
            const emailNotifications = document.getElementById('emailNotifications').checked;
            const pushNotifications = document.getElementById('pushNotifications').checked;
            const smsNotifications = document.getElementById('smsNotifications').checked;
            
            // Save notification preferences
            localStorage.setItem('notificationSettings', JSON.stringify({
                email: emailNotifications,
                push: pushNotifications,
                sms: smsNotifications
            }));
            
            showNotification('Notification preferences saved', 'success');
        }
        
        function exportUserData() {
            showNotification('Data export functionality will be implemented', 'info');
        }
        
        function requestDataDeletion() {
            if (confirm('Are you sure you want to request data deletion? This action cannot be undone.')) {
                showNotification('Data deletion request submitted', 'warning');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        // ID Verification Functions
        function startQRScan() {
            showNotification('QR scanner functionality will be implemented', 'info');
        }
        
        function verifyID() {
            showNotification('ID verification functionality will be implemented', 'info');
        }
        
        function clearScan() {
            document.getElementById('scanResult').style.display = 'none';
            document.getElementById('scanData').textContent = '';
        }
        
        // SOS Functions
        function sendEmergencyAlert() {
            if (confirm('Send emergency alert to all tourists?')) {
                showNotification('Emergency alert sent to all tourists', 'warning');
            }
        }
        
        function contactEmergencyServices() {
            showNotification('Emergency services contact functionality will be implemented', 'info');
        }
        
        function refreshSOSData() {
            showNotification('SOS data refreshed', 'success');
        }
        
        function callEmergency(number) {
            showNotification(`Calling emergency number: ${number}`, 'info');
        }
        
        // Analytics Functions
        function updateAnalytics() {
            const timeRange = document.getElementById('analyticsTimeRange').value;
            const metric = document.getElementById('analyticsMetric').value;
            
            // Update analytics charts and data
            showNotification(`Analytics updated for ${timeRange} - ${metric}`, 'success');
        }
        
        function exportAnalytics() {
            showNotification('Analytics export functionality will be implemented', 'info');
        }
        
        // Settings Functions
        function saveNotificationSettings() {
            showNotification('Notification settings saved', 'success');
        }
        
        function saveSecuritySettings() {
            showNotification('Security settings saved', 'success');
        }
        
        function backupDatabase() {
            showNotification('Database backup started', 'info');
        }
        
        function optimizeDatabase() {
            showNotification('Database optimization completed', 'success');
        }
        
        function clearOldData() {
            if (confirm('Are you sure you want to clear old data? This action cannot be undone.')) {
                showNotification('Old data cleared successfully', 'warning');
            }
        }
        
        // Profile Form Submission
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        fullName: document.getElementById('profileFullName').value.trim(),
                        email: document.getElementById('profileEmail').value.trim(),
                        username: document.getElementById('profileUsername').value.trim(),
                        nationality: document.getElementById('profileNationality').value.trim(),
                        phone: document.getElementById('profilePhone').value.trim()
                    };
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('http://localhost:3000/api/auth/profile', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        if (response.ok) {
                            showNotification('Profile updated successfully!', 'success');
                            // Refresh user data
                            checkAuthentication();
                        } else {
                            const error = await response.json();
                            showNotification(error.message || 'Failed to update profile', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        showNotification('Network error while updating profile', 'error');
                    }
                });
            }
        });
        
        // Support Functions
        document.addEventListener('DOMContentLoaded', function() {
            const supportForm = document.getElementById('supportForm');
            if (supportForm) {
                supportForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const subject = document.getElementById('supportSubject').value.trim();
                    const category = document.getElementById('supportCategory').value;
                    const message = document.getElementById('supportMessage').value.trim();
                    
                    if (!subject || !category || !message) {
                        showNotification('Please fill in all support form fields', 'error');
                        return;
                    }
                    
                    // Submit support request
                    showNotification('Support request submitted successfully', 'success');
                    supportForm.reset();
                });
            }
        });
        
        // Enhanced Digital ID Generation
        async function generateDigitalID() {
            const name = document.getElementById('touristName').value.trim();
            const passport = document.getElementById('passportNumber').value.trim();
            const nationality = document.getElementById('nationality').value.trim();
            const dob = document.getElementById('dateOfBirth').value;
            const contact = document.getElementById('contactNumber').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!name || !passport || !nationality || !dob) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to create digital ID', 'error');
                    return;
                }

                // Show loading state
                const submitBtn = document.querySelector('#digitalIdForm button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating Digital ID...';
                submitBtn.disabled = true;

                const response = await fetch('http://localhost:3000/api/digital-id', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullName: name,
                        nationality: nationality,
                        passportNumber: passport
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const digitalIdData = result.data;
                    
                    // Update ID preview with real data
                    document.getElementById('idName').textContent = name;
                    document.getElementById('idPassport').textContent = `ID: ${digitalIdData.digitalId}`;
                    document.getElementById('idNationality').textContent = nationality;
                    document.getElementById('idDob').textContent = new Date(dob).toLocaleDateString();
                    
                    // Set issue date and expiry date
                    const issueDate = new Date(digitalIdData.issueDate);
                    const expiryDate = new Date(digitalIdData.expiryDate);
                    
                    document.getElementById('idIssueDate').textContent = issueDate.toLocaleDateString();
                    document.getElementById('idValidUntil').textContent = expiryDate.toLocaleDateString();
                    
                    // Display QR code from backend
                    const qrCode = document.getElementById('qrCode');
                    qrCode.innerHTML = '';
                    
                    if (digitalIdData.qrCode) {
                        const img = document.createElement('img');
                        img.src = digitalIdData.qrCode;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        qrCode.appendChild(img);
                    }
                    
                    showNotification('Digital ID created successfully!', 'success');
                    
                    // Store digital ID data for later use
                    localStorage.setItem('digitalId', JSON.stringify(digitalIdData));
                    
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to create digital ID', 'error');
                }
            } catch (error) {
                console.error('Error creating digital ID:', error);
                showNotification('Network error while creating digital ID', 'error');
            } finally {
                // Reset button state
                const submitBtn = document.querySelector('#digitalIdForm button[type="submit"]');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Load existing digital ID
        async function loadDigitalID() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return;
                }

                const response = await fetch('http://localhost:3000/api/digital-id', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const digitalIdData = result.data;
                    
                    // Update ID preview with existing data
                    document.getElementById('idName').textContent = digitalIdData.fullName || '';
                    document.getElementById('idPassport').textContent = `ID: ${digitalIdData.digitalId}`;
                    document.getElementById('idNationality').textContent = digitalIdData.nationality || '';
                    document.getElementById('idDob').textContent = digitalIdData.passportNumber || '';
                    
                    // Set issue date and expiry date
                    const issueDate = new Date(digitalIdData.issueDate);
                    const expiryDate = new Date(digitalIdData.expiryDate);
                    
                    document.getElementById('idIssueDate').textContent = issueDate.toLocaleDateString();
                    document.getElementById('idValidUntil').textContent = expiryDate.toLocaleDateString();
                    
                    // Display QR code
                    const qrCode = document.getElementById('qrCode');
                    qrCode.innerHTML = '';
                    
                    if (digitalIdData.qrCode) {
                        const img = document.createElement('img');
                        img.src = digitalIdData.qrCode;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        qrCode.appendChild(img);
                    }
                    
                    // Store digital ID data
                    localStorage.setItem('digitalId', JSON.stringify(digitalIdData));
                    
                    // Show existing ID message
                    showNotification('Digital ID loaded successfully!', 'info');
                } else if (response.status === 404) {
                    // No digital ID exists yet
                    console.log('No digital ID found for user');
                } else {
                    const error = await response.json();
                    console.error('Error loading digital ID:', error.message);
                }
            } catch (error) {
                console.error('Error loading digital ID:', error);
            }
        }

        // Verify QR code
        async function verifyQRCode(qrData) {
            try {
                const response = await fetch('http://localhost:3000/api/digital-id/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ qrData })
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.data;
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Verification failed');
                }
            } catch (error) {
                console.error('QR verification error:', error);
                throw error;
            }
        }

        // Regenerate QR code
        async function regenerateQRCode() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to regenerate QR code', 'error');
                    return;
                }

                const response = await fetch('http://localhost:3000/api/digital-id/regenerate-qr', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const qrCode = document.getElementById('qrCode');
                    qrCode.innerHTML = '';
                    
                    if (result.data.qrCode) {
                        const img = document.createElement('img');
                        img.src = result.data.qrCode;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        qrCode.appendChild(img);
                    }
                    
                    showNotification('QR code regenerated successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to regenerate QR code', 'error');
                }
            } catch (error) {
                console.error('Error regenerating QR code:', error);
                showNotification('Network error while regenerating QR code', 'error');
            }
        }

        // Download Digital ID
        function downloadDigitalID() {
            const digitalIdData = JSON.parse(localStorage.getItem('digitalId') || '{}');
            if (!digitalIdData.digitalId) {
                showNotification('No digital ID found. Please create one first.', 'error');
                return;
            }

            try {
                const idCard = document.querySelector('.digital-id-card');
                if (!idCard) {
                    showNotification('Digital ID card not found', 'error');
                    return;
                }

                html2canvas(idCard).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `digital-id-${digitalIdData.digitalId}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showNotification('Digital ID downloaded successfully!', 'success');
                }).catch(error => {
                    console.error('Download error:', error);
                    showNotification('Failed to download Digital ID', 'error');
                });
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download Digital ID', 'error');
            }
        }

        // Share Digital ID
        function shareDigitalID() {
            const digitalIdData = JSON.parse(localStorage.getItem('digitalId') || '{}');
            if (!digitalIdData.digitalId) {
                showNotification('No digital ID found. Please create one first.', 'error');
                return;
            }

            if (navigator.share) {
                navigator.share({
                    title: 'My Digital ID - Kavach360',
                    text: `Digital ID: ${digitalIdData.digitalId}`,
                    url: window.location.href
                }).then(() => {
                    showNotification('Digital ID shared successfully!', 'success');
                }).catch(error => {
                    console.error('Share error:', error);
                    // Fallback to copy to clipboard
                    copyToClipboard();
                });
            } else {
                // Fallback to copy to clipboard
                copyToClipboard();
            }
        }

        // Copy to clipboard fallback
        function copyToClipboard() {
            const digitalIdData = JSON.parse(localStorage.getItem('digitalId') || '{}');
            const text = `Digital ID: ${digitalIdData.digitalId}\nBlockchain Hash: ${digitalIdData.blockchainHash}\nIssue Date: ${digitalIdData.issueDate}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Digital ID information copied to clipboard!', 'success');
            }).catch(error => {
                console.error('Copy error:', error);
                showNotification('Failed to copy Digital ID information', 'error');
            });
        }

        // Open verification page
        function openVerificationPage() {
            window.open('verify.html', '_blank');
        }

        // Fix Digital ID form submission
        document.addEventListener('DOMContentLoaded', function() {
            const digitalIdForm = document.getElementById('digitalIdForm');
            if (digitalIdForm) {
                digitalIdForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    generateDigitalID();
                });
            }

            // Load existing digital ID on page load
            loadDigitalID();
        });
        
        // Real-time data updates
        function startRealTimeUpdates() {
            // Update dashboard stats every 30 seconds
            setInterval(() => {
                fetchDashboardStats();
            }, 30000);
            
            // Update alerts every 15 seconds
            setInterval(() => {
                fetchAlerts();
            }, 15000);
            
            // Update tourist locations every 20 seconds
            setInterval(() => {
                fetchTouristLocations();
            }, 20000);
            
            // Update geofence data every 60 seconds
            setInterval(() => {
                fetchGeofenceZones();
            }, 60000);
        }
        
        // Initialize real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(startRealTimeUpdates, 5000); // Start after 5 seconds
            
            // Function to fetch tourist locations
        async function fetchTouristLocations() {
            try {
                showNotification('Fetching tourist locations...', 'info');
                const response = await fetch('/api/tourists/locations', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch tourist locations');
                }

                const data = await response.json();
                
                // Clear existing markers before adding new ones
                clearTouristMarkers();
                
                // Add each tourist to the map
                if (data && data.tourists && Array.isArray(data.tourists)) {
                    data.tourists.forEach(tourist => {
                        updateTouristLocationOnMap(tourist);
                    });
                    showNotification(`Loaded ${data.tourists.length} tourist locations`, 'success');
                } else {
                    showNotification('No tourist location data available', 'info');
                }
            } catch (error) {
                console.error('Error fetching tourist locations:', error);
                showNotification('Error loading tourist locations. Please try again.', 'error');
            }
        }

        // Function to clear all tourist markers from the map
        function clearTouristMarkers() {
            // Remove all existing tourist markers from the map
            Object.values(touristMarkers).forEach(marker => {
                if (marker && window.dashboardMap) {
                    window.dashboardMap.removeLayer(marker);
                }
            });
            
            // Reset the markers object
            touristMarkers = {};
        }
        
        // Initialize Socket.IO connection
        initializeSocketConnection();
        
        // Fetch initial tourist locations after map is initialized
        setTimeout(() => {
            if (window.dashboardMap) {
                fetchTouristLocations();
            }
        }, 2000);
        
        // Function to fetch tourist locations from the API
        async function fetchTouristLocations() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No authentication token found');
                    showNotification('Please log in to view tourist locations', 'warning');
                    return;
                }
                
                // Check if server is running first
                const serverRunning = await checkServerHealth();
                if (!serverRunning) {
                    showNotification('Server is not running. Please start the backend server.', 'error');
                    return;
                }
                
                const response = await fetch('http://localhost:3000/api/tourists/locations', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Authentication expired, redirecting to login');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`Error: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.status === 'success' && Array.isArray(data.data.tourists)) {
                    console.log('Fetched tourist locations:', data.data.tourists);
                    
                    // Update tourist markers on the map
                    data.data.tourists.forEach(tourist => {
                        updateTouristLocationOnMap({
                            userId: tourist.id,
                            touristId: tourist.id,
                            touristName: tourist.name,
                            latitude: tourist.latitude,
                            longitude: tourist.longitude,
                            timestamp: tourist.last_updated || Date.now()
                        });
                    });
                    
                    // Update tourist count in stats
                    const activeTouristsEl = document.getElementById('activeTourists');
                    if (activeTouristsEl) {
                        activeTouristsEl.textContent = data.data.tourists.length;
                    }
                }
            } catch (error) {
                console.error('Error fetching tourist locations:', error);
                showNotification('Failed to fetch tourist locations', 'error');
            }
        }
        });
        
        // Socket.IO connection and event handling
        function initializeSocketConnection() {
            try {
                // Connect to Socket.IO server
                const socket = io('http://localhost:3000', {
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                    timeout: 10000
                });
                
                // Store socket reference globally
                window.dashboardSocket = socket;
                
                // Connection events
                socket.on('connect', () => {
                    console.log('Connected to real-time server');
                    showNotification('Connected to real-time tracking server', 'success');
                    
                    // Join user room if authenticated
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    if (user && user.id) {
                        socket.emit('join-user-room', user.id);
                    }
                });
                
                socket.on('connect_error', (error) => {
                    console.error('Connection error:', error);
                    showNotification('Failed to connect to tracking server. Retrying...', 'error');
                });
                
                socket.on('disconnect', (reason) => {
                    console.log('Disconnected from server:', reason);
                    if (reason === 'io server disconnect') {
                        // Server disconnected us, try to reconnect
                        socket.connect();
                    }
                });
                
                // Tourist location updates
                socket.on('location-update', (locationData) => {
                    console.log('Received location update:', locationData);
                    updateTouristLocationOnMap(locationData);
                });
                
                // Alert notifications
                socket.on('alert-notification', (alertData) => {
                    console.log('Received alert notification:', alertData);
                    showNotification(`Alert: ${alertData.message || 'New alert received'}`, 'warning');
                    // Refresh alerts list
                    fetchAlerts();
                });
                
                // Tourist location updates
                socket.on('tourist-location', (locationData) => {
                    console.log('Received tourist location update:', locationData);
                    if (locationData && locationData.touristId && locationData.latitude && locationData.longitude) {
                        updateTouristLocationOnMap(locationData);
                    }
                });
                
                // SOS alerts
                socket.on('sos-alert', (sosData) => {
                    console.log('Received SOS alert:', sosData);
                    
                    // Show prominent notification
                    const notification = document.createElement('div');
                    notification.className = 'sos-notification';
                    notification.innerHTML = `
                        <div class="sos-notification-content">
                            <h3><i class="fas fa-exclamation-triangle"></i> SOS EMERGENCY ALERT</h3>
                            <p><strong>Tourist:</strong> ${sosData.touristName || 'Unknown'}</p>
                            <p><strong>Location:</strong> [${sosData.latitude?.toFixed(6) || '?'}, ${sosData.longitude?.toFixed(6) || '?'}]</p>
                            <p><strong>Time:</strong> ${new Date(sosData.timestamp || Date.now()).toLocaleTimeString()}</p>
                            <div class="sos-actions">
                                <button onclick="respondToSOS('${sosData.id}')" class="btn btn-primary">Respond</button>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-outline">Dismiss</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Play alert sound if available
                    const alertSound = document.getElementById('alertSound');
                    if (alertSound) {
                        alertSound.play().catch(e => console.error('Error playing alert sound:', e));
                    }
                    
                    // Center map on SOS location if available
                    if (window.dashboardMap && sosData.latitude && sosData.longitude) {
                        window.dashboardMap.setView([sosData.latitude, sosData.longitude], 15);
                        
                        // Add special SOS marker
                        const sosMarker = L.marker([sosData.latitude, sosData.longitude], {
                            icon: L.divIcon({
                                className: 'sos-marker',
                                html: `<div style="background-color: #e63946; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-exclamation-triangle"></i></div>`,
                                iconSize: [40, 40],
                                iconAnchor: [20, 20]
                            })
                        }).addTo(window.dashboardMap);
                        
                        // Add pulsing effect
                        const markerElement = sosMarker.getElement();
                        if (markerElement) {
                            markerElement.classList.add('sos-pulse-animation');
                        }
                        
                        // Store SOS marker reference
                        if (!window.sosMarkers) {
                            window.sosMarkers = {};
                        }
                        window.sosMarkers[sosData.id] = sosMarker;
                    }
                    
                    // Refresh alerts
                    fetchAlerts();
                });
            } catch (error) {
                console.error('Error initializing Socket.IO:', error);
                showNotification('Failed to initialize real-time tracking. Please refresh the page.', 'error');
            }
        }
        
        // Respond to SOS alert
        function respondToSOS(sosId) {
            // Update SOS alert status to 'responding'
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Authentication required to respond to SOS', 'error');
                return;
            }
            
            fetch(`http://localhost:3000/api/alerts/sos/${sosId}/respond`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Response to SOS alert recorded', 'success');
                    // Refresh alerts
                    fetchAlerts();
                } else {
                    throw new Error(data.message || 'Failed to respond to SOS alert');
                }
            })
            .catch(error => {
                console.error('Error responding to SOS:', error);
                showNotification('Failed to respond to SOS alert: ' + error.message, 'error');
            });
        }
    </script>
    
    <!-- Multilingual Support Scripts -->
    <script type="module" src="translations.js"></script>
    <script type="module" src="multilingual.js"></script>
    
    <!-- Tourist Tracking System -->
    <script src="tourist-tracking.js"></script>
    
    <!-- AI Anomaly Detection System -->
    <script src="anomaly-detection.js"></script>

<style>
/* Anomaly Detection Styles */
.anomaly-control {
    position: absolute;
    top: 70px;
    right: 10px;
    background: white;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    padding: 10px;
    z-index: 1000;
    width: 250px;
}

.control-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-switch label {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.toggle-switch label:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

.toggle-switch input:checked + label {
    background-color: #2196F3;
}

.toggle-switch input:checked + label:before {
    transform: translateX(20px);
}

.anomaly-categories {
    margin-top: 10px;
}

.category-toggle {
    display: flex;
    align-items: center;
    margin: 5px 0;
}

.category-toggle input {
    margin-right: 5px;
}

.anomaly-marker {
    display: flex;
    align-items: center;
    justify-content: center;
}

.marker-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    color: white;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
}

.pulse {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
    }
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
    }
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
    }
}

.anomaly-popup {
    min-width: 200px;
}

.anomaly-popup h4 {
    margin-top: 0;
    margin-bottom: 10px;
}

.popup-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.anomaly-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.anomaly-chart-container {
    height: 200px;
    margin-bottom: 15px;
}

.anomaly-heatmap-container {
    margin-bottom: 15px;
}

#anomalyHeatmap {
    width: 100%;
    height: 300px;
    position: relative;
    background: #f5f5f5;
    border-radius: 4px;
    overflow: hidden;
}

.heatmap-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    opacity: 0.7;
    z-index: 1;
}

.confidence-bar {
    height: 20px;
    background-color: #ccc;
    border-radius: 10px;
    text-align: center;
    color: white;
    font-size: 12px;
    line-height: 20px;
    font-weight: bold;
    transition: width 0.3s ease;
}

.confidence-bar.high {
    background-color: #ff0000;
}

.confidence-bar.medium {
    background-color: #ffaa00;
}

.confidence-bar.low {
    background-color: #00cc00;
}

.modal-container {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    border-radius: 5px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    width: 80%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
}

.modal-body {
    padding: 15px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.anomaly-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.detail-confidence {
    text-align: right;
}

.confidence-value {
    font-size: 24px;
    font-weight: bold;
    margin: 5px 0;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-items {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.detail-item {
    padding: 5px 0;
}

.detail-map-container,
.detail-chart-container {
    height: 300px;
    margin: 10px 0;
}

.detail-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255,255,255,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</body>
</html>